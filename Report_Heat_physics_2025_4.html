<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高校物理・熱力学レポートシステム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; }
        .tab-button.active { border-color: #3b82f6; background-color: #eff6ff; color: #3b82f6; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .task-card { border-left: 5px solid #3b82f6; }
        .report-section { border-top: 2px solid #e5e7eb; }
        .screenshot-preview { max-width: 100%; max-height: 200px; margin-top: 10px; border: 1px solid #ccc; padding: 5px; }
        .problem-image { max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 1rem; }
        .answer-options label { display: block; margin-bottom: 0.5rem; }
        /* PDF出力用のスタイル */
        #pdf-render-area {
            font-family: 'Noto Sans JP', sans-serif;
            padding: 20px;
            background-color: #ffffff;
            color: #000000;
        }
        #pdf-render-area h1, #pdf-render-area h2, #pdf-render-area h3 {
            font-weight: bold;
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
            margin-top: 15px;
        }
        #pdf-render-area img {
            max-width: 80%;
            display: block;
            margin: 10px 0;
            border: 1px solid #ddd;
        }
        #pdf-render-area pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">高校物理 熱力学レポートシステム</h1>
            <p class="text-gray-600 mt-2">サイクルビルダーシミュレーターを使って課題に取り組み、レポートを作成・提出しましょう。</p>
        </header>

        <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-8 rounded-md" role="alert">
            <p class="font-bold">シミュレーターの準備</p>
            <p>このシステムは、サイクルビルダーシミュレーターと合わせて使用します。シミュレーターを別のタブまたはウィンドウで開いてから課題に取り組んでください。</p>
            <a href="https://takeruhonda.github.io/physics-thermo-sim/Heat_physics_2025_6.html" target="_blank" rel="noopener noreferrer" class="inline-block mt-2 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
                サイクルビルダーを開く
            </a>
        </div>

        <nav class="flex flex-wrap justify-center border-b-2 border-gray-200 mb-8 space-x-2 bg-white rounded-t-lg p-2 shadow-sm">
            <button data-tab="report-creation" class="tab-button font-semibold py-3 px-6 border-b-4 border-transparent rounded-md hover:bg-gray-100 focus:outline-none active">課題レポート作成</button>
            <button data-tab="dashboard" class="tab-button font-semibold py-3 px-6 border-b-4 border-transparent rounded-md hover:bg-gray-100 focus:outline-none">教員用ダッシュボード</button>
        </nav>

        <main class="bg-white p-6 rounded-b-lg shadow-sm">
            <section id="report-creation" class="content-section active">
                <form id="report-form" class="space-y-8">
                    <div class="space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label for="student-id" class="font-semibold text-lg">出席番号:</label>
                                <input type="text" id="student-id" placeholder="例：10" class="mt-1 p-2 border border-gray-300 rounded-md shadow-sm w-full">
                            </div>
                            <div>
                                <label for="student-name" class="font-semibold text-lg">氏名:</label>
                                <input type="text" id="student-name" placeholder="例：山田 太郎" class="mt-1 p-2 border border-gray-300 rounded-md shadow-sm w-full">
                            </div>
                        </div>
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                             <label for="load-json-input" class="font-semibold text-yellow-800">作業の再開:</label>
                             <p class="text-sm text-yellow-700 mb-2">保存したレポートファイル(JSON)を読み込んで、編集を再開できます。</p>
                             <p class="text-sm text-red-600 font-bold mt-2">(注意) 再開した場合は、スクリーンショットのプレビューが表示されていても、ファイル自体は選択されていません。PDFに画像を含めるには、お手数ですが再度スクリーンショットを選択し直してください。</p>
                             <input type="file" id="load-json-input" accept=".json" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-yellow-100 file:text-yellow-700 hover:file:bg-yellow-200 mt-2">
                        </div>
                    </div>


                    <div class="task-card bg-gray-50 p-6 rounded-lg">
                        <h3 class="text-xl font-bold mb-3">課題1 (問題78)：複数の状態変化の比較と仕事の大小関係</h3>
                        <p class="mb-4">この課題では、気体の体積を同じだけ減少させるときに、「断熱」「等温」「定圧」の各過程でどのような違いがあるかを探求します。特に、気体が外部からされる仕事の大小関係や、温度と体積の関係（V-Tグラフ）に着目しましょう。</p>
                        <div class="text-center my-4">
                            <img src="Q1.png" alt="問題78の画像" class="problem-image mx-auto">
                        </div>
                        <div class="answer-options bg-white p-4 rounded-md mt-4">
                             <h4 class="text-lg font-semibold mb-3">問題の解答</h4>
                            <p class="font-semibold">問1：次の文中の空欄ア・イ に入れる記号の組合せとして正しいものを、下の①～⑨のうちから1つ選べ。</p>
                            <p class="italic my-2">熱の出入りがない過程はアであり、内部エネルギーが変化しない過程はイである。</p>
                            <select id="q78_1" class="mt-2 p-2 border rounded w-full md:w-1/2">
                                <option value="">選択してください</option>
                                <option value="1">① (ア:a, イ:a)</option><option value="2">② (ア:a, イ:b)</option><option value="3">③ (ア:a, イ:c)</option>
                                <option value="4">④ (ア:b, イ:a)</option><option value="5">⑤ (ア:b, イ:b)</option><option value="6">⑥ (ア:b, イ:c)</option>
                                <option value="7">⑦ (ア:c, イ:a)</option><option value="8">⑧ (ア:c, イ:b)</option><option value="9">⑨ (ア:c, イ:c)</option>
                            </select>
                            <p class="font-semibold mt-4">問2：過程(a), (b), (c)において、気体が外部からされる仕事をそれぞれ W<sub>a</sub>, W<sub>b</sub>, W<sub>c</sub> とする。これらの大小関係として正しいものを、次の①～⑥のうちから1つ選べ。</p>
                            <select id="q78_2" class="mt-2 p-2 border rounded w-full md:w-1/2">
                                <option value="">選択してください</option>
                                <option value="1">① W<sub>a</sub> &lt; W<sub>b</sub> &lt; W<sub>c</sub></option>
                                <option value="2">② W<sub>a</sub> &lt; W<sub>c</sub> &lt; W<sub>b</sub></option>
                                <option value="3">③ W<sub>b</sub> &lt; W<sub>a</sub> &lt; W<sub>c</sub></option>
                                <option value="4">④ W<sub>b</sub> &lt; W<sub>c</sub> &lt; W<sub>a</sub></option>
                                <option value="5">⑤ W<sub>c</sub> &lt; W<sub>a</sub> &lt; W<sub>b</sub></option>
                                <option value="6">⑥ W<sub>c</sub> &lt; W<sub>b</sub> &lt; W<sub>a</sub></option>
                            </select>
                            <p class="font-semibold mt-4">問3：図2に示した温度と体積の関係を表す実線ウ～カのうち3つは、過程(a), (b), (c)に対応する。どの実線が過程(a), (b), (c)に対応するか。組合せとして正しいものを、下の①～⑧のうちから1つ選べ。</p>
                            <select id="q78_3" class="mt-2 p-2 border rounded w-full md:w-1/2">
                               <option value="">選択してください</option>
                               <option value="1">① (a:ウ, b:エ, c:オ)</option><option value="2">② (a:ウ, b:オ, c:カ)</option><option value="3">③ (a:エ, b:ウ, c:オ)</option>
                               <option value="4">④ (a:エ, b:オ, c:カ)</option><option value="5">⑤ (a:オ, b:ウ, c:カ)</option><option value="6">⑥ (a:オ, b:カ, c:エ)</option>
                               <option value="7">⑦ (a:カ, b:ウ, c:エ)</option><option value="8">⑧ (a:カ, b:オ, c:ウ)</option>
                            </select>
                        </div>
                         <div class="report-section pt-6 mt-6">
                            <h4 class="text-lg font-semibold mb-3">シミュレーションと考察</h4>
                            <div>
                                <label class="block font-semibold mb-2">方法（シミュレーション設定）：</label>
                                <p class="text-sm mb-2 text-gray-600">同じ初期状態から、3つの過程（定圧・等温・断熱）をそれぞれシミュレーションし、同じ最終体積まで圧縮してください。その設定を以下に記録します。</p>
                                <div id="q1-method-steps"></div>
                                <button type="button" class="add-step-btn mt-2 text-sm bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 px-3 rounded" data-target="q1-method-steps">＋ ステップを追加</button>
                            </div>
                            <div class="mt-4"><label class="block font-semibold mb-2">結果（グラフのスクリーンショット）：</label><input type="file" id="q1-screenshot" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"><img id="q1-preview" class="screenshot-preview hidden" alt="Screenshot Preview"></div>
                            <div class="mt-4"><label class="block font-semibold mb-2">わかったこと・考察：</label><textarea id="q1-findings" class="w-full p-2 border border-gray-300 rounded-md" rows="3" placeholder="PVグラフの面積（仕事）の大小関係や、VTグラフの形状について、なぜそうなると考えたかを記述してください。"></textarea></div>
                             <div class="mt-4"><label class="block font-semibold mb-2">この課題の理解度：</label>
                                <select id="q1-understanding" class="w-full p-2 border border-gray-300 rounded-md">
                                    <option value="5">5: よく理解できた</option><option value="4">4: 理解できた</option><option value="3" selected>3: 普通</option><option value="2">2: あまり理解できなかった</option><option value="1">1: 全く理解できなかった</option>
                                </select>
                             </div>
                        </div>
                    </div>

                    <div class="task-card bg-gray-50 p-6 rounded-lg">
                        <h3 class="text-xl font-bold mb-3">課題2 (問題79)：熱機関のサイクル（循環過程）の理解</h3>
                        <p class="mb-4">この課題では、複数の状態変化を組み合わせた「サイクル」をシミュレーターで再現し、熱機関全体のエネルギーの流れを追跡します。各状態の物理量を計算し、熱力学第一法則がサイクル全体でどのように成り立つかを確認しましょう。</p>
                        <div class="text-center my-4">
                            <img src="Q2.png" alt="問題79の画像" class="problem-image mx-auto">
                        </div>
                         <div class="answer-options bg-white p-4 rounded-md mt-4">
                            <h4 class="text-lg font-semibold mb-3">問題の解答</h4>
                            <p class="font-semibold">問1：状態bの気体の圧力はいくらか。</p>
                            <select id="q79_1" class="mt-2 p-2 border rounded w-full md:w-1/2">
                                <option value="">選択してください</option>
                                <option value="1">① 1/4 p₀</option><option value="2">② 1/3 p₀</option><option value="3">③ 1/2 p₀</option>
                                <option value="4">④ 2/3 p₀</option><option value="5">⑤ p₀</option><option value="6">⑥ 3/2 p₀</option>
                            </select>
                            <p class="font-semibold mt-4">問2：状態cの気体の温度はいくらか。</p>
                             <select id="q79_2" class="mt-2 p-2 border rounded w-full md:w-1/2">
                                <option value="">選択してください</option>
                                <option value="1">① 1/2 T₀</option><option value="2">② T₀</option><option value="3">③ 3/2 T₀</option>
                                <option value="4">④ 2 T₀</option><option value="5">⑤ 5/2 T₀</option><option value="6">⑥ 3 T₀</option>
                            </select>
                            <p class="font-semibold mt-4">問3</p>
                            <p class="ml-4">(1) a→bの過程で、気体が外界からされる仕事と外界から吸収する熱量の和はいくらか。</p>
                            <select id="q79_3_1" class="mt-2 p-2 border rounded w-full md:w-1/2 ml-4">
                               <option value="">選択してください</option>
                               <option value="1">① nRT₀</option>
                               <option value="2">② -nRT₀</option>
                               <option value="3">③ nCpT₀</option>
                               <option value="4">④ -nCpT₀</option>
                               <option value="5">⑤ nCvT₀</option>
                               <option value="6">⑥ -nCvT₀</option>
                               <option value="7">⑦ 0</option>
                            </select>
                            <p class="ml-4 mt-2">(2) 状態d, aの気体の内部エネルギーをそれぞれ Ud, Ua とするとき、d→aの過程での内部エネルギーの変化、Ua - Ud はいくらか。</p>
                            <select id="q79_3_2" class="mt-2 p-2 border rounded w-full md:w-1/2 ml-4">
                               <option value="">選択してください</option>
                               <option value="1">① nRT₀</option>
                               <option value="2">② -nRT₀</option>
                               <option value="3">③ nCpT₀</option>
                               <option value="4">④ -nCpT₀</option>
                               <option value="5">⑤ nCvT₀</option>
                               <option value="6">⑥ -nCvT₀</option>
                               <option value="7">⑦ 0</option>
                            </select>
                            <p class="ml-4 mt-2">(3) 圧力を一定に保って、状態cから状態aにもどる過程を考える。このc→aの過程で気体が外界からされる仕事Wと、外界から吸収する熱量Qは、それぞれいくらか。</p>
                             <div class="ml-4 mt-2 flex flex-wrap items-center gap-4">
                                 <span>仕事W:</span>
                                 <select id="q79_3_3_W" class="p-2 border rounded w-full md:w-1/3">
                                    <option value="">選択</option>
                                    <option value="1">① nRT₀</option>
                                    <option value="2">② -nRT₀</option>
                                    <option value="3">③ nCpT₀</option>
                                    <option value="4">④ -nCpT₀</option>
                                    <option value="5">⑤ nCvT₀</option>
                                    <option value="6">⑥ -nCvT₀</option>
                                    <option value="7">⑦ 0</option>
                                 </select>
                                 <span>熱量Q:</span>
                                 <select id="q79_3_3_Q" class="p-2 border rounded w-full md:w-1/2">
                                    <option value="">選択</option>
                                    <option value="1">① nRT₀</option>
                                    <option value="2">② -nRT₀</option>
                                    <option value="3">③ nCpT₀</option>
                                    <option value="4">④ -nCpT₀</option>
                                    <option value="5">⑤ nCvT₀</option>
                                    <option value="6">⑥ -nCvT₀</option>
                                    <option value="7">⑦ 0</option>
                                 </select>
                             </div>
                        </div>
                        <div class="report-section pt-6 mt-6">
                           <h4 class="text-lg font-semibold mb-3">シミュレーションと考察</h4>
                            <div>
                                <label class="block font-semibold mb-2">方法（シミュレーション設定）：</label>
                                <p class="text-sm mb-2 text-gray-600">問題文のサイクルa→b→c→d→aをシミュレーターで再現してください。各ステップの設定を記録します。</p>
                                <div id="q2-method-steps"></div>
                                <button type="button" class="add-step-btn mt-2 text-sm bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 px-3 rounded" data-target="q2-method-steps">＋ ステップを追加</button>
                            </div>
                            <div class="mt-4"><label class="block font-semibold mb-2">結果（状態遷移図のスクリーンショットと各過程のQ, W', ΔU）：</label><input type="file" id="q2-screenshot" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"><img id="q2-preview" class="screenshot-preview hidden" alt="Screenshot Preview"><textarea id="q2-results" class="w-full p-2 border border-gray-300 rounded-md mt-2" rows="3" placeholder="各過程とサイクル全体でのQ, W', ΔUの値を記述してください。"></textarea></div>
                            <div class="mt-4"><label class="block font-semibold mb-2">わかったこと・考察：</label><textarea id="q2-findings" class="w-full p-2 border border-gray-300 rounded-md" rows="3" placeholder="等温変化ではΔU=0となるためQ+W=0となることや、サイクル全体でのエネルギーの変化について考察を記述してください。"></textarea></div>
                             <div class="mt-4"><label class="block font-semibold mb-2">この課題の理解度：</label>
                                <select id="q2-understanding" class="w-full p-2 border border-gray-300 rounded-md">
                                    <option value="5">5: よく理解できた</option><option value="4">4: 理解できた</option><option value="3" selected>3: 普通</option><option value="2">2: あまり理解できなかった</option><option value="1">1: 全く理解できなかった</option>
                                </select>
                             </div>
                        </div>
                    </div>

                    <div class="task-card bg-gray-50 p-6 rounded-lg">
                        <h3 class="text-xl font-bold mb-3">課題3 (問題83)：断熱変化と等温変化の性質の比較</h3>
                         <p class="mb-4">気体を膨張させる際に、「等温変化」と「断熱変化」でp-Vグラフの軌跡がどのように異なるかを比較します。シミュレーターで両方の変化を再現し、グラフの傾きの違いに注目してください。</p>
                        <div class="text-center my-4">
                             <img src="Q3.png" alt="問題83の画像" class="problem-image mx-auto">
                        </div>
                        <div class="answer-options bg-white p-4 rounded-md mt-4">
                            <h4 class="text-lg font-semibold mb-3">問題の解答</h4>
                            <p class="font-semibold">問：次の文章中の空欄 ア～ウ に入れる語と式の組合せとして最も適当なものを、次の①～④のうちから1つ選べ。</p>
                             <p class="italic my-2">図2は、容器内の理想気体の圧力pと体積Vの関係(p-Vグラフ)を示している。ここで、実線はア、破線はイを表しており、これを用いるとL等温とL断熱の大小関係は、ウである。</p>
                            <select id="q83_1" class="mt-2 p-2 border rounded w-full md:w-1/2">
                                <option value="">選択してください</option>
                                <option value="1">① (ア:等温, イ:断熱, ウ:L等温&lt;L断熱)</option>
                                <option value="2">② (ア:等温, イ:断熱, ウ:L等温&gt;L断熱)</option>
                                <option value="3">③ (ア:断熱, イ:等温, ウ:L等温&lt;L断熱)</option>
                                <option value="4">④ (ア:断熱, イ:等温, ウ:L等温&gt;L断熱)</option>
                            </select>
                        </div>
                         <div class="report-section pt-6 mt-6">
                            <h4 class="text-lg font-semibold mb-3">シミュレーションと考察</h4>
                            <div>
                                <label class="block font-semibold mb-2">方法（シミュレーション設定）：</label>
                                 <p class="text-sm mb-2 text-gray-600">同じ初期状態から「等温変化」と「断熱変化」をそれぞれ行い、同じ最終圧力まで膨張させてください。</p>
                                <div id="q3-method-steps"></div>
                                <button type="button" class="add-step-btn mt-2 text-sm bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 px-3 rounded" data-target="q3-method-steps">＋ ステップを追加</button>
                            </div>
                            <div class="mt-4"><label class="block font-semibold mb-2">結果（P-Vグラフのスクリーンショット）：</label><input type="file" id="q3-screenshot" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"><img id="q3-preview" class="screenshot-preview hidden" alt="Screenshot Preview"></div>
                            <div class="mt-4"><label class="block font-semibold mb-2">わかったこと・考察：</label><textarea id="q3-findings" class="w-full p-2 border border-gray-300 rounded-md" rows="3" placeholder="断熱膨張では温度が下がるため、同じ圧力変化でも体積変化が小さいことを、グラフと熱力学第一法則から説明してください。"></textarea></div>
                             <div class="mt-4"><label class="block font-semibold mb-2">この課題の理解度：</label>
                                <select id="q3-understanding" class="w-full p-2 border border-gray-300 rounded-md">
                                    <option value="5">5: よく理解できた</option><option value="4">4: 理解できた</option><option value="3" selected>3: 普通</option><option value="2">2: あまり理解できなかった</option><option value="1">1: 全く理解できなかった</option>
                                </select>
                             </div>
                        </div>
                    </div>

                    <div class="task-card bg-gray-50 p-6 rounded-lg">
                        <h3 class="text-xl font-bold mb-3">課題4 (問題73)：断熱圧縮における物理量の変化</h3>
                         <p class="mb-4">断熱圧縮を行うと、なぜ気体の温度は上昇するのでしょうか。シミュレーターで断熱圧縮を再現し、熱力学第一法則（ΔU = Q + W）に基づいてその理由を考察します。</p>
                         <div class="text-center my-4">
                            <img src="Q4.png" alt="問題73の画像" class="problem-image mx-auto">
                        </div>
                        <div class="answer-options bg-white p-4 rounded-md mt-4">
                            <h4 class="text-lg font-semibold mb-3">問題の解答</h4>
                            <p class="font-semibold">問：容器に閉じこめられた気体の断熱変化に関する記述として誤っているものを、次の①～④のうちから1つ選べ。</p>
                            <select id="q73_1" class="mt-2 p-2 border rounded w-full md:w-1/2">
                                <option value="">選択してください</option>
                                <option value="1">① 気体を圧縮する断熱変化では、気体の圧力は増加する。</option>
                                <option value="2">② 気体を圧縮する断熱変化では、気体分子の平均の速さは増加する。</option>
                                <option value="3">③ 断熱変化では、外部から気体になされた仕事は内部エネルギーの増加分に等しくなる。</option>
                                <option value="4">④ 断熱変化では、熱の出入りがないので体積が変化しても気体の温度は変わらない。</option>
                            </select>
                        </div>
                        <div class="report-section pt-6 mt-6">
                           <h4 class="text-lg font-semibold mb-3">シミュレーションと考察</h4>
                            <div>
                                <label class="block font-semibold mb-2">方法（シミュレーション設定）：</label>
                                 <p class="text-sm mb-2 text-gray-600">「断熱変化」で気体の体積を減少（圧縮）させてください。その設定を記録します。</p>
                                <div id="q4-method-steps"></div>
                                <button type="button" class="add-step-btn mt-2 text-sm bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 px-3 rounded" data-target="q4-method-steps">＋ ステップを追加</button>
                            </div>
                            <div class="mt-4"><label class="block font-semibold mb-2">結果（観察された物理量の変化）：</label><textarea id="q4-results" class="w-full p-2 border border-gray-300 rounded-md" rows="3" placeholder="体積を減少させたとき、圧力と温度がどのように変化したか、またその時のQとW'の値を記述してください。"></textarea></div>
                            <div class="mt-4"><label class="block font-semibold mb-2">わかったこと・考察：</label><textarea id="q4-findings" class="w-full p-2 border border-gray-300 rounded-md" rows="3" placeholder="断熱変化ではQ=0なので、ΔU = Wとなります。外部から仕事をされた（W>0）結果、内部エネルギーΔUが増加し、温度が上昇することを説明してください。"></textarea></div>
                             <div class="mt-4"><label class="block font-semibold mb-2">この課題の理解度：</label>
                                <select id="q4-understanding" class="w-full p-2 border border-gray-300 rounded-md">
                                    <option value="5">5: よく理解できた</option><option value="4">4: 理解できた</option><option value="3" selected>3: 普通</option><option value="2">2: あまり理解できなかった</option><option value="1">1: 全く理解できなかった</option>
                                </select>
                             </div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-8 pt-8 border-t-2">
                        <div class="bg-green-100 border-l-4 border-green-500 text-green-800 p-4 mb-6 rounded-md text-left" role="alert">
                            <p class="font-bold">📝 ファイルの提出について</p>
                            <p>下のボタンを両方クリックし、作成された<strong>PDFファイル</strong>と<strong>JSONファイル</strong>の２つをGoogle Classroomの課題に添付して提出してください。</p>
                        </div>
                        <button type="button" id="generate-report-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition-colors">レポートファイル(JSON)を生成</button>
                        <button type="button" id="export-pdf-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition-colors">PDFへ書き出し</button>
                    </div>
                </form>
            </section>
            
            <section id="dashboard" class="content-section">
                <h2 class="text-2xl font-bold mb-4">教員用ダッシュボード</h2>
                <div class="bg-gray-50 p-6 rounded-lg">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-lg font-semibold mb-3">レポートファイルの一括読み込み</h3>
                            <p class="text-sm text-gray-600 mb-2">生徒から提出されたレポートファイル（.json）を複数選択して、一括で読み込ませてください。</p>
                        </div>
                        <button id="export-csv-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors hidden">CSV形式で書き出し</button>
                    </div>
                    <input type="file" id="report-files-input" multiple accept=".json" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                </div>

                <div id="dashboard-results" class="mt-8 space-y-8 hidden">
                    <div>
                        <h3 class="text-xl font-bold mb-3">提出状況サマリー</h3>
                        <div id="submission-summary" class="bg-white p-4 rounded-lg shadow-sm"></div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-xl font-bold mb-3">課題別 平均正答率</h3>
                            <div class="bg-white p-4 rounded-lg shadow-sm">
                                <canvas id="score-chart"></canvas>
                            </div>
                        </div>
                         <div>
                            <h3 class="text-xl font-bold mb-3">考察 記入率</h3>
                            <div class="bg-white p-4 rounded-lg shadow-sm">
                                <canvas id="progress-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-xl font-bold mb-3">提出ファイル一覧</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white rounded-lg shadow-sm">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="p-3 text-left font-semibold">出席番号</th>
                                        <th class="p-3 text-left font-semibold">氏名</th>
                                        <th class="p-3 text-center font-semibold">理解度(1/2/3/4)</th>
                                        <th class="p-3 text-center font-semibold">進捗</th>
                                        <th class="p-3 text-center font-semibold">レポート</th>
                                    </tr>
                                </thead>
                                <tbody id="results-table-body">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Answer Key
    const answerKey = {
        q78_1: "2", q78_2: "6", q78_3: "8",
        q79_1: "3", q79_2: "4", q79_3_1: "7", q79_3_2: "6", 
        q79_3_3_W: "1", 
        q79_3_3_Q: "4",
        q83_1: "2",
        q73_1: "4",
    };
    
    let allReportData = [];

    // Tab switching logic
    const tabs = document.querySelectorAll('.tab-button');
    const sections = document.querySelectorAll('.content-section');
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            sections.forEach(s => s.classList.remove('active'));
            const activeTab = document.getElementById(tab.dataset.tab);
            if (activeTab) activeTab.classList.add('active');
        });
    });
    if(tabs.length > 0) { document.getElementById(tabs[0].dataset.tab).classList.add('active'); }

    // Student ID input handling
    const studentIdInput = document.getElementById('student-id');
    studentIdInput.addEventListener('input', (e) => {
        e.target.value = e.target.value.replace(/[Ａ-Ｚａ-ｚ０-９]/g, function(s) {
            return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
        }).toUpperCase();
    });

    // Method step creation
    function createMethodStep(stepData = {}) {
        const newStep = document.createElement('div');
        newStep.className = 'method-step';
        newStep.innerHTML = `
            <select class="p-1 border rounded text-sm method-process"><option value="isobaric">定圧</option><option value="isochoric">定積</option><option value="isothermal">等温</option><option value="adiabatic">断熱</option></select>
            <select class="p-1 border rounded text-sm method-param"><option value="P">圧力</option><option value="V">体積</option><option value="T">温度</option></select>
            <select class="p-1 border rounded text-sm method-type"><option value="absolute">絶対値</option><option value="multiple">倍数</option></select>
            <input type="number" class="p-1 border rounded text-sm method-value" value="1" step="0.1">
            <button type="button" class="remove-step-btn text-red-500 text-xs">削除</button>
        `;
        
        if (stepData.process) newStep.querySelector('.method-process').value = stepData.process;
        if (stepData.param) newStep.querySelector('.method-param').value = stepData.param;
        if (stepData.type) newStep.querySelector('.method-type').value = stepData.type;
        if (stepData.value) newStep.querySelector('.method-value').value = stepData.value;
        
        newStep.querySelector('.remove-step-btn').addEventListener('click', () => newStep.remove());
        return newStep;
    }

    document.querySelectorAll('.add-step-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const targetId = e.target.dataset.target;
            const container = document.getElementById(targetId);
            container.appendChild(createMethodStep());
        });
    });

    // Screenshot preview logic
    function setupScreenshotPreview(inputId, previewId) {
        const input = document.getElementById(inputId);
        const preview = document.getElementById(previewId);
        if (input) {
            input.addEventListener('change', () => {
                const file = input.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        preview.src = e.target.result;
                        preview.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
    }
    setupScreenshotPreview('q1-screenshot', 'q1-preview');
    setupScreenshotPreview('q2-screenshot', 'q2-preview');
    setupScreenshotPreview('q3-screenshot', 'q3-preview');
    setupScreenshotPreview('q4-screenshot', 'q4-preview');

    function getStudentAnswers() {
        return {
            q78_1: document.getElementById('q78_1').value, q78_2: document.getElementById('q78_2').value, q78_3: document.getElementById('q78_3').value,
            q79_1: document.getElementById('q79_1').value, q79_2: document.getElementById('q79_2').value, q79_3_1: document.getElementById('q79_3_1').value, q79_3_2: document.getElementById('q79_3_2').value, q79_3_3_W: document.getElementById('q79_3_3_W').value, q79_3_3_Q: document.getElementById('q79_3_3_Q').value,
            q83_1: document.getElementById('q83_1').value,
            q73_1: document.getElementById('q73_1').value,
        };
    }
    
    function getMethodSteps(containerId) {
        const container = document.getElementById(containerId);
        if (!container) return [];
        return Array.from(container.children).map(step => ({
            process: step.querySelector('.method-process').value,
            param: step.querySelector('.method-param').value,
            type: step.querySelector('.method-type').value,
            value: step.querySelector('.method-value').value
        }));
    }

    function gradeAnswers(studentAnswers) {
        const results = {};
        const q_defs = {
            q1: ["q78_1", "q78_2", "q78_3"],
            q2: ["q79_1", "q79_2", "q79_3_1", "q79_3_2", "q79_3_3_W", "q79_3_3_Q"],
            q3: ["q83_1"],
            q4: ["q73_1"]
        };
        results.totalScore = 0;
        results.totalQuestions = 0;
        Object.keys(q_defs).forEach(q_key => {
            const keys_for_q = q_defs[q_key];
            results[q_key] = { correct: 0, total: keys_for_q.length, details: {} };
            keys_for_q.forEach(key => {
                const isCorrect = studentAnswers[key] === answerKey[key];
                results[q_key].details[key] = isCorrect;
                if(isCorrect) results[q_key].correct++;
            });
            results.totalScore += results[q_key].correct;
            results.totalQuestions += keys_for_q.length;
        });
        return results;
    }

    async function generateReportData() {
        const toBase64 = file => new Promise((resolve) => {
            if (!file) { resolve(null); return; }
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = () => resolve(null);
        });
        
        return {
            studentId: document.getElementById('student-id').value.trim() || '（番号未入力）',
            studentName: document.getElementById('student-name').value.trim() || '（氏名未入力）',
            submissionDate: new Date().toISOString(),
            answers: getStudentAnswers(),
            grading: gradeAnswers(getStudentAnswers()),
            q1: { method: getMethodSteps('q1-method-steps'), screenshot: await toBase64(document.getElementById('q1-screenshot').files[0]), findings: document.getElementById('q1-findings').value, understanding: document.getElementById('q1-understanding').value },
            q2: { method: getMethodSteps('q2-method-steps'), results: document.getElementById('q2-results').value, screenshot: await toBase64(document.getElementById('q2-screenshot').files[0]), findings: document.getElementById('q2-findings').value, understanding: document.getElementById('q2-understanding').value },
            q3: { method: getMethodSteps('q3-method-steps'), screenshot: await toBase64(document.getElementById('q3-screenshot').files[0]), findings: document.getElementById('q3-findings').value, understanding: document.getElementById('q3-understanding').value },
            q4: { method: getMethodSteps('q4-method-steps'), results: document.getElementById('q4-results').value, findings: document.getElementById('q4-findings').value, understanding: document.getElementById('q4-understanding').value }
        };
    }
    
    function validateInputs() {
        const studentId = document.getElementById('student-id').value.trim();
        const studentName = document.getElementById('student-name').value.trim();
        if (!studentId || !studentName) {
            alert('出席番号と氏名を入力してください。');
            return false;
        }
        return true;
    }

    // JSON書き出しボタンのイベントリスナー
    document.getElementById('generate-report-btn').addEventListener('click', async () => {
        if (!validateInputs()) {
            return;
        }
        
        // JSON保存時にはプレビューのBase64も保存対象にする
        const dataToSave = await generateReportData();
        ['q1', 'q2', 'q3', 'q4'].forEach(qKey => {
            const preview = document.getElementById(`${qKey}-preview`);
            if (preview && preview.src.startsWith('data:image')) {
                dataToSave[qKey].screenshot = preview.src;
            }
        });

        const blob = new Blob([JSON.stringify(dataToSave, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `thermo_report_${dataToSave.studentId}_${dataToSave.studentName.replace(/\s/g, '_')}.json`;
        a.click();
        URL.revokeObjectURL(url);
        alert('レポートファイル(JSON)が生成されました！');
    });

    // PDF書き出しボタンのイベントリスナー
    document.getElementById('export-pdf-btn').addEventListener('click', async () => {
        if (!validateInputs()) {
            return;
        }

        exportPdfBtn.disabled = true;
        exportPdfBtn.textContent = 'PDF生成中...';

        // PDF生成用のデータを作成（ファイルが選択されていればそれを優先、なければプレビュー画像を使う）
        const dataForPdf = await generateReportData();
        const screenshotPromises = ['q1', 'q2', 'q3', 'q4'].map(qKey => {
            return new Promise(async (resolve) => {
                const fileInput = document.getElementById(`${qKey}-screenshot`);
                if (fileInput && fileInput.files[0]) {
                    const reader = new FileReader();
                    reader.readAsDataURL(fileInput.files[0]);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = () => resolve(null);
                } else {
                    const preview = document.getElementById(`${qKey}-preview`);
                    if (preview && preview.src.startsWith('data:image')) {
                        resolve(preview.src);
                    } else {
                        resolve(null);
                    }
                }
            });
        });

        const screenshots = await Promise.all(screenshotPromises);
        dataForPdf.q1.screenshot = screenshots[0];
        dataForPdf.q2.screenshot = screenshots[1];
        dataForPdf.q3.screenshot = screenshots[2];
        dataForPdf.q4.screenshot = screenshots[3];
        
        const getSelectedText = (selectId) => {
             const select = document.getElementById(selectId);
             return select.selectedIndex > 0 ? select.options[select.selectedIndex].text : "未解答";
        };
        const u_text = val => ({'5':'よく理解できた','4':'理解できた','3':'普通','2':'あまり理解できなかった','1':'全く理解できなかった'}[val] || '未評価');
        const formatMethod = (steps) => steps.map((s, i) => `  Step ${i+1}: ${s.process}, ${s.param}, ${s.type}, 値=${s.value}`).join('\n');
        const escapeHtml = (text) => text ? text.replace(/</g, "&lt;").replace(/>/g, "&gt;") : '';
        
        const reportHtml = `
            <div id="pdf-render-area" style="width: 210mm; background: white; color: black; padding: 20mm;">
                <h1>高校物理 熱力学レポート</h1>
                <p><strong>出席番号:</strong> ${escapeHtml(dataForPdf.studentId)}</p>
                <p><strong>氏名:</strong> ${escapeHtml(dataForPdf.studentName)}</p>
                <p><strong>提出日時:</strong> ${new Date(dataForPdf.submissionDate).toLocaleString('ja-JP')}</p>
                <p><strong>正答率:</strong> ${dataForPdf.grading.totalScore} / ${dataForPdf.grading.totalQuestions} (${(dataForPdf.grading.totalScore/dataForPdf.grading.totalQuestions*100).toFixed(1)}%)</p>

                <h2>課題1：複数の状態変化の比較</h2>
                <h3>解答</h3>
                <p>問1: ${getSelectedText('q78_1')} (${dataForPdf.grading.q1.details.q78_1 ? "正解" : "不正解"})</p>
                <p>問2: ${getSelectedText('q78_2')} (${dataForPdf.grading.q1.details.q78_2 ? "正解" : "不正解"})</p>
                <p>問3: ${getSelectedText('q78_3')} (${dataForPdf.grading.q1.details.q78_3 ? "正解" : "不正解"})</p>
                <h3>シミュレーションと考察</h3>
                <p><strong>理解度:</strong> ${u_text(dataForPdf.q1.understanding)}</p>
                <p><strong>方法:</strong></p><pre>${formatMethod(dataForPdf.q1.method)}</pre>
                <p><strong>スクリーンショット:</strong></p>${dataForPdf.q1.screenshot ? `<img src="${dataForPdf.q1.screenshot}">` : '<p>なし</p>'}
                <p><strong>考察:</strong></p><pre>${escapeHtml(dataForPdf.q1.findings) || '（未記入）'}</pre>

                <h2>課題2：熱機関のサイクル</h2>
                <h3>解答</h3>
                <p>問1: ${getSelectedText('q79_1')} (${dataForPdf.grading.q2.details.q79_1 ? "正解" : "不正解"})</p>
                <p>問2: ${getSelectedText('q79_2')} (${dataForPdf.grading.q2.details.q79_2 ? "正解" : "不正解"})</p>
                <p>問3(1): ${getSelectedText('q79_3_1')} (${dataForPdf.grading.q2.details.q79_3_1 ? "正解" : "不正解"})</p>
                <p>問3(2): ${getSelectedText('q79_3_2')} (${dataForPdf.grading.q2.details.q79_3_2 ? "正解" : "不正解"})</p>
                <p>問3(3) 仕事W: ${getSelectedText('q79_3_3_W')} (${dataForPdf.grading.q2.details.q79_3_3_W ? "正解" : "不正解"})</p>
                <p>問3(3) 熱量Q: ${getSelectedText('q79_3_3_Q')} (${dataForPdf.grading.q2.details.q79_3_3_Q ? "正解" : "不正解"})</p>
                <h3>シミュレーションと考察</h3>
                <p><strong>理解度:</strong> ${u_text(dataForPdf.q2.understanding)}</p>
                <p><strong>方法:</strong></p><pre>${formatMethod(dataForPdf.q2.method)}</pre>
                <p><strong>結果:</strong></p><pre>${escapeHtml(dataForPdf.q2.results) || '（未記入）'}</pre>
                <p><strong>スクリーンショット:</strong></p>${dataForPdf.q2.screenshot ? `<img src="${dataForPdf.q2.screenshot}">` : '<p>なし</p>'}
                <p><strong>考察:</strong></p><pre>${escapeHtml(dataForPdf.q2.findings) || '（未記入）'}</pre>

                <h2>課題3：断熱変化と等温変化の性質の比較</h2>
                <h3>解答</h3>
                <p>問1: ${getSelectedText('q83_1')} (${dataForPdf.grading.q3.details.q83_1 ? "正解" : "不正解"})</p>
                <h3>シミュレーションと考察</h3>
                <p><strong>理解度:</strong> ${u_text(dataForPdf.q3.understanding)}</p>
                <p><strong>方法:</strong></p><pre>${formatMethod(dataForPdf.q3.method)}</pre>
                <p><strong>スクリーンショット:</strong></p>${dataForPdf.q3.screenshot ? `<img src="${dataForPdf.q3.screenshot}">` : '<p>なし</p>'}
                <p><strong>考察:</strong></p><pre>${escapeHtml(dataForPdf.q3.findings) || '（未記入）'}</pre>
                
                <h2>課題4：断熱圧縮における物理量の変化</h2>
                <h3>解答</h3>
                <p>問1: ${getSelectedText('q73_1')} (${dataForPdf.grading.q4.details.q73_1 ? "正解" : "不正解"})</p>
                <h3>シミュレーションと考察</h3>
                <p><strong>理解度:</strong> ${u_text(dataForPdf.q4.understanding)}</p>
                <p><strong>方法:</strong></p><pre>${formatMethod(dataForPdf.q4.method)}</pre>
                <p><strong>結果:</strong></p><pre>${escapeHtml(dataForPdf.q4.results) || '（未記入）'}</pre>
                <p><strong>考察:</strong></p><pre>${escapeHtml(dataForPdf.q4.findings) || '（未記入）'}</pre>
            </div>
        `;

        const renderContainer = document.createElement('div');
        renderContainer.style.position = 'absolute';
        renderContainer.style.left = '-2999px';
        renderContainer.style.top = '0';
        renderContainer.innerHTML = reportHtml;
        document.body.appendChild(renderContainer);
        
        try {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'p',
                unit: 'mm',
                format: 'a4'
            });

            const content = document.getElementById('pdf-render-area');
            
            await html2canvas(content, {
                scale: 2,
                useCORS: true,
                onclone: (doc) => {
                    const link = doc.createElement('link');
                    link.rel = 'stylesheet';
                    link.href = 'https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap';
                    doc.head.appendChild(link);
                }
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgProps= pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

                let heightLeft = pdfHeight;
                let position = 0;
                
                pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight, undefined, 'FAST');
                heightLeft -= pdf.internal.pageSize.getHeight();
                
                while (heightLeft >= 0) {
                  position = heightLeft - pdfHeight;
                  pdf.addPage();
                  pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight, undefined, 'FAST');
                  heightLeft -= pdf.internal.pageSize.getHeight();
                }

                pdf.save(`thermo_report_${dataForPdf.studentId}_${dataForPdf.studentName.replace(/\s/g, '_')}.pdf`);
            });
        } catch (error) {
            console.error("PDF生成に失敗しました:", error);
            alert("PDFの生成に失敗しました。コンソールを確認してください。");
        } finally {
            document.body.removeChild(renderContainer);
            exportPdfBtn.disabled = false;
            exportPdfBtn.textContent = 'PDFへ書き出し';
        }
    });

    const loadJsonInput = document.getElementById('load-json-input');
    loadJsonInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) {
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                populateForm(data);
                alert('レポートファイルが正常に読み込まれました。');
            } catch (err) {
                alert('ファイルの読み込みに失敗しました。有効なJSONレポートファイルを選択してください。');
                console.error(err);
            }
        };
        reader.readAsText(file);
        event.target.value = '';
    });

    function populateForm(data) {
        document.getElementById('student-id').value = data.studentId || '';
        document.getElementById('student-name').value = data.studentName || '';

        if (data.answers) {
            for (const [key, value] of Object.entries(data.answers)) {
                const selectElement = document.getElementById(key);
                if (selectElement) {
                    selectElement.value = value;
                }
            }
        }
        
        const questionData = { q1: data.q1, q2: data.q2, q3: data.q3, q4: data.q4 };
        for (const [qKey, qValue] of Object.entries(questionData)) {
            if (!qValue) continue;

            const methodContainer = document.getElementById(`${qKey}-method-steps`);
            if (methodContainer && qValue.method) {
                methodContainer.innerHTML = ''; // クリア
                qValue.method.forEach(stepData => {
                    methodContainer.appendChild(createMethodStep(stepData));
                });
            }
            
            const findings = document.getElementById(`${qKey}-findings`);
            if (findings && qValue.findings) findings.value = qValue.findings;
            
            const results = document.getElementById(`${qKey}-results`);
            if (results && qValue.results) results.value = qValue.results;
            
            const understanding = document.getElementById(`${qKey}-understanding`);
            if (understanding && qValue.understanding) understanding.value = qValue.understanding;

            const preview = document.getElementById(`${qKey}-preview`);
            if (preview && qValue.screenshot) {
                preview.src = qValue.screenshot;
                preview.classList.remove('hidden');
            } else if (preview) {
                preview.src = '';
                preview.classList.add('hidden');
            }
        }
    }

    // Dashboard logic
    const reportFilesInput = document.getElementById('report-files-input');
    const dashboardResults = document.getElementById('dashboard-results');
    let progressChartInstance = null, scoreChartInstance = null;
    
    reportFilesInput.addEventListener('change', async (event) => {
        allReportData = [];
        for (const file of event.target.files) {
            try {
                const data = JSON.parse(await file.text());
                data.fileName = file.name;
                allReportData.push(data);
            } catch (e) { alert(`ファイル ${file.name} の読み込みに失敗しました。`); }
        }
        if (allReportData.length > 0) { displayDashboard(allReportData); }
    });

    function displayDashboard(data) {
        dashboardResults.classList.remove('hidden');
        document.getElementById('export-csv-btn').classList.remove('hidden');
        updateSubmissionSummary(data);
        updateProgressChart(data);
        updateScoreChart(data);
        updateResultsTable(data);
    }
    
    function updateSubmissionSummary(data) {
        document.getElementById('submission-summary').innerHTML = `<p><strong>提出者数:</strong> ${data.length}名</p>`;
    }

    function updateProgressChart(data) {
        const progress = { q1: 0, q2: 0, q3: 0, q4: 0 };
        data.forEach(r => {
            if (r.q1?.findings?.trim()) progress.q1++;
            if (r.q2?.findings?.trim()) progress.q2++;
            if (r.q3?.findings?.trim()) progress.q3++;
            if (r.q4?.findings?.trim()) progress.q4++;
        });
        const ctx = document.getElementById('progress-chart').getContext('2d');
        if (progressChartInstance) progressChartInstance.destroy();
        progressChartInstance = new Chart(ctx, { type: 'bar', data: { labels: ['課題1', '課題2', '課題3', '課題4'], datasets: [{ label: '記入率', data: Object.values(progress).map(p => data.length > 0 ? p / data.length * 100 : 0), backgroundColor: 'rgba(59, 130, 246, 0.5)' }] }, options: { scales: { y: { beginAtZero: true, max: 100, ticks: { callback: v => v + "%" } } }, plugins: { title: { display: true, text: `考察 記入率 (全${data.length}名)` } } } });
    }

    function updateScoreChart(data) {
        const scores = { q1: 0, q2: 0, q3: 0, q4: 0 };
        const totals = { q1: 0, q2: 0, q3: 0, q4: 0 };
        data.forEach(r => {
            if(r.grading) {
                ['q1','q2','q3','q4'].forEach(q => { 
                    if (r.grading[q]) {
                        scores[q] += r.grading[q].correct; 
                        totals[q] += r.grading[q].total; 
                    }
                });
            }
        });
        const avgScores = ['q1','q2','q3','q4'].map(q => totals[q] > 0 ? (scores[q] / totals[q] * 100) : 0);
        const ctx = document.getElementById('score-chart').getContext('2d');
        if (scoreChartInstance) scoreChartInstance.destroy();
        scoreChartInstance = new Chart(ctx, { type: 'bar', data: { labels: ['課題1', '課題2', '課題3', '課題4'], datasets: [{ label: '平均正答率', data: avgScores, backgroundColor: 'rgba(22, 163, 74, 0.5)' }] }, options: { scales: { y: { beginAtZero: true, max: 100, ticks: { callback: v => v.toFixed(0) + "%" } } }, plugins: { title: { display: true, text: `課題別 平均正答率` } } } });
    }

    function updateResultsTable(data) {
        const tableBody = document.getElementById('results-table-body');
        tableBody.innerHTML = '';
        data.sort((a,b) => (a.studentId || "").localeCompare(b.studentId || ""));
        data.forEach(report => {
            const row = document.createElement('tr');
            const progressCount = [report.q1, report.q2, report.q3, report.q4].reduce((acc, q) => acc + (q && ( (q.method && q.method.length>0) || q.results?.trim()) && q.findings?.trim() ? 1 : 0), 0);
            const progressHtml = `<div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-blue-600 h-2.5 rounded-full" style="width: ${progressCount/4*100}%"></div></div>`;
            const u_map = r => [r.q1, r.q2, r.q3, r.q4].map(q => q ? q.understanding : '-').join('/');
            
            row.innerHTML = `
                <td class="p-3 border-b">${report.studentId || '(未設定)'}</td>
                <td class="p-3 border-b">${report.studentName || '(未設定)'}</td>
                <td class="p-3 border-b text-center">${u_map(report)}</td>
                <td class="p-3 border-b text-center">${progressHtml}</td>
                <td class="p-3 border-b text-center"><button class="view-report-btn text-blue-500 underline" data-filename="${report.fileName}">表示</button></td>
            `;
            tableBody.appendChild(row);
        });
        document.querySelectorAll('.view-report-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                alert("この機能は現在サポートされていません。");
            });
        });
    }
    
    document.getElementById('export-csv-btn').addEventListener('click', () => {
        if(allReportData.length === 0) return;
        let csvContent = "\uFEFF"; // BOM for Excel
        const headers = ["出席番号", "氏名", "提出日時", "総合点", "合計問題数", "正答率(%)", "理解度1", "理解度2", "理解度3", "理解度4", "進捗(%)"];
        csvContent += headers.join(",") + "\r\n";
        
        allReportData.sort((a,b) => (a.studentId || "").localeCompare(b.studentId || "")).forEach(r => {
            const progressCount = [r.q1, r.q2, r.q3, r.q4].reduce((acc, q) => acc + (q && ( (q.method && q.method.length>0) || q.results?.trim()) && q.findings?.trim() ? 1 : 0), 0);
            const progressPercent = (progressCount / 4 * 100).toFixed(1);

            const grading = r.grading || { totalScore: 0, totalQuestions: 0 };
            const scorePercent = grading.totalQuestions > 0 ? (grading.totalScore / grading.totalQuestions * 100).toFixed(1) : "0.0";
            
            const row = [
                `"${r.studentId || ''}"`,
                `"${r.studentName || ''}"`,
                `"${r.submissionDate ? new Date(r.submissionDate).toLocaleString('ja-JP') : ''}"`,
                grading.totalScore,
                grading.totalQuestions,
                scorePercent,
                r.q1 ? r.q1.understanding : '-',
                r.q2 ? r.q2.understanding : '-',
                r.q3 ? r.q3.understanding : '-',
                r.q4 ? r.q4.understanding : '-',
                progressPercent
            ];
            csvContent += row.join(",") + "\r\n";
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `report_summary_${new Date().toISOString().slice(0,10)}.csv`;
        a.click();
        URL.revokeObjectURL(url);
    });
});
</script>
</body>
</html>
