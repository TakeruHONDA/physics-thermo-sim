<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高校物理 熱力学 理解度チェック</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- KaTeX for mathematical notation -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" xintegrity="sha384-n8MVd4RsNIU0KOVEMVIhbGKLCePo231CVQSHcLesaPSAHUsqAPLC2HSSg52OzwlW" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" xintegrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" xintegrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>

    <style>
        /* Custom styles for the application */
        body {
            font-family: 'Helvetica Neue', 'Arial', 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', 'Meiryo', sans-serif;
        }
        .katex { font-size: 1.1em; }
        .option-btn { transition: all 0.2s ease-in-out; }
        .option-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .option-btn.selected { border-color: #3b82f6; background-color: #dbeafe; }
        .option-btn.correct { background-color: #dcfce7; border-color: #22c55e; }
        .option-btn.incorrect { background-color: #fee2e2; border-color: #ef4444; }
        .toc-item.active { background-color: #e0f2fe; color: #0c4a6e; font-weight: bold; }
        .toc-item.completed { background-color: #dcfce7; color: #166534; }
        .progress-bar-inner { transition: width 0.5s ease-in-out; }
        /* Hide default file input */
        input[type="file"] {
            display: none;
        }
        /* Teacher mode TOC styles */
        .toc-topic-group summary {
            font-weight: bold;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.375rem;
        }
        .toc-topic-group summary:hover {
            background-color: #f3f4f6;
        }
        .toc-question-btn {
            text-align: left;
            width: 100%;
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            border-radius: 0.375rem;
        }
        .toc-question-btn:hover {
            background-color: #e0f2fe;
        }
        .toc-question-btn.active {
            background-color: #bae6fd;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="flex flex-col md:flex-row min-h-screen">
        <!-- Table of Contents (Sidebar) -->
        <aside id="sidebar" class="w-full md:w-72 bg-white border-r border-gray-200 p-4 md:p-6">
            <h2 id="toc-title" class="text-xl font-bold mb-4 text-gray-700">目次</h2>
            <div id="toc" class="space-y-1">
                <!-- TOC items will be generated by JavaScript -->
            </div>
            <div id="sidebar-footer" class="mt-8">
                <button id="end-quiz-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                    終了しレポートを作成
                </button>
                 <button id="exit-teacher-mode-btn" class="hidden w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                    先生モードを終了
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 p-4 md:p-8">
            <div id="quiz-container" class="max-w-4xl mx-auto">
                <!-- Current Topic Header -->
                <div class="mb-6 p-4 bg-white rounded-xl shadow">
                    <p id="mode-indicator" class="text-sm font-bold text-purple-600"></p>
                    <p class="text-sm text-gray-500">現在の単元</p>
                    <h1 id="current-topic-title" class="text-2xl font-bold text-sky-800"></h1>
                </div>

                <!-- Question Area -->
                <div id="question-area" class="bg-white p-6 md:p-8 rounded-xl shadow-lg">
                    <div id="question-text" class="text-lg leading-relaxed mb-6"></div>
                    <div id="options-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Option buttons will be generated by JavaScript -->
                    </div>
                    <div class="mt-8 text-center">
                        <button id="check-answer-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-10 rounded-lg shadow-lg transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none" disabled>
                            答え合わせ
                        </button>
                    </div>
                </div>

                <!-- Explanation Area (Initially Hidden) -->
                <div id="explanation-area" class="hidden mt-6 bg-white p-6 md:p-8 rounded-xl shadow-lg border-t-8">
                    <h2 id="result-title" class="text-3xl font-bold mb-4"></h2>
                    <p class="font-bold mb-2 text-gray-700">正解：</p>
                    <div id="correct-answer-text" class="mb-4 p-3 bg-gray-100 rounded-md"></div>
                    <p class="font-bold mb-2 text-gray-700">解説：</p>
                    <div id="explanation-text" class="leading-relaxed space-y-3"></div>
                    <hr class="my-6">
                    <div id="understanding-buttons" class="text-center">
                        <p class="mb-4 font-semibold text-lg">この解説で理解できましたか？</p>
                        <button onclick="app.handleUnderstanding(true)" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-lg mr-4 shadow-lg transition-transform transform hover:scale-105">理解できた</button>
                        <button onclick="app.handleUnderstanding(false)" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105">理解できなかった</button>
                    </div>
                     <div id="teacher-next-buttons" class="hidden text-center">
                        <button onclick="app.jumpToNextQuestion()" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105">次の問題へ</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal for Start and Report -->
    <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div id="start-modal" class="bg-white rounded-2xl shadow-2xl p-8 max-w-lg w-full text-center transform transition-all scale-100">
            <h1 class="text-3xl font-bold text-sky-800 mb-4">熱力学 理解度チェック</h1>
            <p class="text-gray-600 mb-6">はじめに、モードを選択するか、出席番号と名前を入力してください。</p>
            <div class="space-y-4 mb-6">
                <input type="text" id="student-id-input" placeholder="出席番号" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="text" id="student-name-input" placeholder="名前" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <button id="start-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg text-lg shadow-lg transition-transform transform hover:scale-105 mb-3">
                学習を開始する
            </button>
            <button id="teacher-mode-btn" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-4 rounded-lg text-lg shadow-lg transition-transform transform hover:scale-105 mb-3">
                先生モードで開始
            </button>
            <div class="grid grid-cols-2 gap-3">
                <label for="load-progress-input" class="w-full cursor-pointer inline-block bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg text-lg shadow-lg transition-transform transform hover:scale-105">
                    続きから再開
                </label>
                <input type="file" id="load-progress-input" accept=".json">
                <label for="load-report-input" class="w-full cursor-pointer inline-block bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg text-lg shadow-lg transition-transform transform hover:scale-105">
                    レポート読込
                </label>
                <input type="file" id="load-report-input" accept=".json">
            </div>
        </div>
        
        <div id="report-modal" class="hidden bg-white rounded-2xl shadow-2xl p-8 max-w-4xl w-full transform transition-all scale-95 opacity-0 overflow-y-auto max-h-screen">
            <h1 class="text-3xl font-bold text-sky-800 mb-2 text-center">学習レポート</h1>
            <div id="report-student-info" class="text-center text-gray-600 mb-6"></div>
            <div id="report-content" class="mb-6">
                <!-- Report table will be generated here -->
            </div>
             <div id="report-review-content" class="mb-6">
                <!-- Review Report table will be generated here -->
            </div>
            <div id="report-teacher-mode-info" class="mb-6">
                <!-- Teacher mode info will be generated here -->
            </div>
            <div id="report-history-section" class="mb-6">
                 <!-- History timeline will be generated here -->
            </div>
            <div class="text-center space-x-4">
                 <button id="review-btn" class="hidden bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                    復習を開始する
                </button>
                 <button id="save-progress-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                    進捗を保存して最初の画面に戻る
                </button>
                 <button id="restart-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                    問題に戻る
                </button>
            </div>
        </div>
    </div>


<script>
// Main application logic
const app = {
    // Application state
    state: {
        studentId: '',
        studentName: '',
        startedAt: null,
        resumedHistory: [],
        currentTopicIndex: 0,
        currentGroupIndex: 0,
        topicGroups: [],
        currentQuestion: null,
        selectedAnswerIndex: null,
        answeredCorrectly: false,
        usedQuestionIds: new Set(),
        reportData: {},
        isReviewMode: false,
        reviewQueue: [],
        isTeacherMode: false,
        teacherModeHistory: [], 
        saveHistory: [], // NEW: Track save history
    },

    // DOM Elements
    elements: {
        sidebar: document.getElementById('sidebar'),
        toc: document.getElementById('toc'),
        tocTitle: document.getElementById('toc-title'),
        endQuizBtn: document.getElementById('end-quiz-btn'),
        exitTeacherModeBtn: document.getElementById('exit-teacher-mode-btn'),
        modeIndicator: document.getElementById('mode-indicator'),
        currentTopicTitle: document.getElementById('current-topic-title'),
        questionArea: document.getElementById('question-area'),
        questionText: document.getElementById('question-text'),
        optionsGrid: document.getElementById('options-grid'),
        checkAnswerBtn: document.getElementById('check-answer-btn'),
        explanationArea: document.getElementById('explanation-area'),
        resultTitle: document.getElementById('result-title'),
        correctAnswerText: document.getElementById('correct-answer-text'),
        explanationText: document.getElementById('explanation-text'),
        understandingButtons: document.getElementById('understanding-buttons'),
        teacherNextButtons: document.getElementById('teacher-next-buttons'),
        modalOverlay: document.getElementById('modal-overlay'),
        startModal: document.getElementById('start-modal'),
        reportModal: document.getElementById('report-modal'),
        startBtn: document.getElementById('start-btn'),
        teacherModeBtn: document.getElementById('teacher-mode-btn'), 
        loadProgressInput: document.getElementById('load-progress-input'),
        loadReportInput: document.getElementById('load-report-input'),
        saveProgressBtn: document.getElementById('save-progress-btn'),
        reviewBtn: document.getElementById('review-btn'),
        restartBtn: document.getElementById('restart-btn'),
        studentIdInput: document.getElementById('student-id-input'),
        studentNameInput: document.getElementById('student-name-input'),
        reportStudentInfo: document.getElementById('report-student-info'),
        reportContent: document.getElementById('report-content'),
        reportReviewContent: document.getElementById('report-review-content'),
        reportTeacherModeInfo: document.getElementById('report-teacher-mode-info'), 
        reportHistorySection: document.getElementById('report-history-section'), // NEW
    },

    // Data: Topics and Questions
    data: {
        topics: [
            "熱と熱量",
            "熱と物質の状態",
            "熱力学第一法則",
            "不可逆変化と熱機関",
            "気体の法則と状態方程式",
            "気体分子の運動"
        ],
        questions: [
            // Questions 1-16 are unchanged
            { id: 1, topicIndex: 0, group: 'temp-conversion', question: "セルシウス温度で27℃は、絶対温度で何Kか。", options: ["-246 K", "0 K", "27 K", "273 K", "300 K", "546 K"], answer: 4, explanation: "絶対温度 \\(T\\) [K] とセルシウス温度 \\(t\\) [℃] の関係は \\(T = t + 273\\) です。したがって、\\(T = 27 + 273 = 300\\) K となります。" },
            { id: 2, topicIndex: 0, group: 'temp-conversion', question: "絶対温度が0Kのとき、セルシウス温度は何℃か。", options: ["-373 ℃", "-273 ℃", "0 ℃", "100 ℃", "273 ℃", "マイナスにはならない"], answer: 1, explanation: "絶対温度 \\(T\\) [K] とセルシウス温度 \\(t\\) [℃] の関係は \\(T = t + 273\\) です。これを変形して \\(t = T - 273\\) となります。したがって、\\(t = 0 - 273 = -273\\) ℃ となります。これは絶対零度と呼ばれます。" },
            { id: 3, topicIndex: 0, group: 'heat-capacity', question: "質量100gのある物体の温度を5.0K上昇させるのに200Jの熱量が必要だった。この物体の比熱 \\(c\\) [J/(g·K)] はいくらか。", options: ["0.40", "0.80", "2.0", "4.0", "10", "20"], answer: 0, explanation: "熱量 \\(Q\\)、質量 \\(m\\)、比熱 \\(c\\)、温度変化 \\(\\Delta T\\) の関係式 \\(Q = mc\\Delta T\\) を用います。これを \\(c\\) について解くと \\(c = Q / (m\\Delta T)\\) となります。値を代入すると、\\(c = 200 / (100 \\times 5.0) = 200 / 500 = 0.40\\) J/(g·K) となります。" },
            { id: 4, topicIndex: 0, group: 'heat-capacity', question: "比熱が0.50 J/(g·K)の物質200gの熱容量 \\(C\\) [J/K] はいくらか。", options: ["25 J/K", "50 J/K", "100 J/K", "200 J/K", "400 J/K", "計算できない"], answer: 2, explanation: "熱容量 \\(C\\) は、質量 \\(m\\) と比熱 \\(c\\) を用いて \\(C = mc\\) と表されます。値を代入すると、\\(C = 200 \\times 0.50 = 100\\) J/K となります。熱容量は、物体の温度を1K上昇させるのに必要な熱量を表します。" },
            { id: 5, topicIndex: 0, group: 'heat-conservation', question: "10℃の水100gと、90℃の湯100gを混ぜた。熱平衡になったときの温度は何℃か。外部との熱のやりとりはないものとする。", options: ["30℃", "40℃", "45℃", "50℃", "60℃", "80℃"], answer: 3, explanation: "低温の水が得る熱量と高温の湯が失う熱量が等しいという熱量保存則を用います。水の比熱を \\(c\\)、平衡温度を \\(t\\) とすると、\\(100 \\times c \\times (t - 10) = 100 \\times c \\times (90 - t)\\) が成り立ちます。両辺を \\(100c\\) で割ると \\(t - 10 = 90 - t\\) となり、\\(2t = 100\\) から \\(t = 50\\)℃ となります。" },
            { id: 6, topicIndex: 0, group: 'heat-conservation', question: "断熱容器に入った20℃の水150gに、100℃に熱した質量100gの金属球を入れたところ、全体の温度が30℃になった。この金属の比熱 \\(c\\) [J/(g·K)] はいくらか。水の比熱を4.2 J/(g·K)とする。", options: ["0.42", "0.60", "0.90", "1.2", "2.1", "4.2"], answer: 2, explanation: "金属球が失った熱量と水が得た熱量は等しくなります。\\(Q_{失} = 100 \\times c \\times (100 - 30)\\)、\\(Q_{得} = 150 \\times 4.2 \\times (30 - 20)\\)。\\(Q_{失} = Q_{得}\\) より、\\(100 \\times c \\times 70 = 150 \\times 4.2 \\times 10\\)。\\(7000c = 6300\\) となり、\\(c = 6300 / 7000 = 0.90\\) J/(g·K) となります。" },
            { id: 7, topicIndex: 0, group: 'thermal-energy', question: "「熱」と「内部エネルギー」に関する記述として、物理的に最も適切なものはどれか。", options: ["高温の物体は、多くの「熱」を持っている。", "「内部エネルギー」とは、物体に出入りするエネルギーのことである。", "「熱」は物体が持つエネルギー（ストック）である。", "「内部エネルギー」は物体が持つエネルギー（ストック）であり、「熱」は移動するエネルギー（フロー）である。", "物体の温度を上げると、その物体が持つ「熱」の量が増える。", "仕事と熱は、どちらも物体が内部に蓄えることができる。"], answer: 3, explanation: "物理学では、物体がその状態に応じて内部に蓄えているエネルギーを「内部エネルギー」（ストック）と呼びます。一方、「熱」や「仕事」は、物体間でエネルギーが移動する際の形態や過程（フロー）を指します。物体が「熱を持っている」という表現は日常的に使いますが、物理的には「内部エネルギーが大きい」と表現するのが正確です。熱は、あくまで温度差があるときに高温物体から低温物体へ移動するエネルギーの流れを指す言葉です。" },
            { id: 8, topicIndex: 0, group: 'thermal-energy', question: "「熱」がエネルギーの移動形態（フロー）であり、仕事と等価であることを示した実験はどれか。", options: ["ボイルの法則", "ジュールの実験", "シャルルの法則", "フックの法則", "運動量保存則", "ケプラーの法則"], answer: 1, explanation: "ジュールの実験は、おもりの落下による仕事が水の温度を上昇させる（内部エネルギーを増加させる）ことを示し、仕事と熱が等価であることを定量的に明らかにしました。この実験により、熱が物体に蓄えられる「もの」ではなく、仕事と同様にエネルギーを変化させる「過程」であることが示されました。" },
            { id: 9, topicIndex: 1, group: 'latent-heat', question: "0℃の氷10gを、すべて0℃の水にするのに必要な熱量は何Jか。氷の融解熱を334 J/gとする。", options: ["33.4 J", "100 J", "334 J", "1000 J", "3340 J", "融解熱だけでは計算できない"], answer: 4, explanation: "状態変化に必要な熱量 \\(Q\\) は、質量 \\(m\\) と潜熱 \\(L\\) を用いて \\(Q = mL\\) と表されます。ここでは融解熱が潜熱にあたります。\\(Q = 10 \\times 334 = 3340\\) J となります。" },
            { id: 10, topicIndex: 1, group: 'latent-heat', question: "100℃の水蒸気20gが、すべて100℃の水になるときに放出する熱量は何Jか。水の蒸発熱を2260 J/gとする。", options: ["113 J", "226 J", "2260 J", "22600 J", "45200 J", "計算できない"], answer: 4, explanation: "状態変化で放出される熱量も \\(Q = mL\\) で計算できます。ここでは蒸発熱が潜熱にあたります。\\(Q = 20 \\times 2260 = 45200\\) J となります。凝縮する際には、蒸発するときと同じ大きさの熱量を放出します。" },
            { 
                id: 11, topicIndex: 1, group: 'state-change-graph', 
                question: "-20℃の氷を加熱していったときの、加えた熱量と温度の関係を表すグラフとして最も適切なものはどれか。縦軸が温度、横軸が加えた熱量を表す。", 
                options: [
                    { text: "A", svg: '<svg viewBox="0 0 100 70" class="w-full h-24"><path d="M 10 5 L 10 65 L 95 65" fill="none" stroke="gray" stroke-width="1"/><text x="0" y="15" font-size="12">T</text><text x="90" y="60" font-size="12">Q</text><polyline points="10,60 95,5" fill="none" stroke="#3b82f6" stroke-width="2"/></svg>' },
                    { text: "B", svg: '<svg viewBox="0 0 100 70" class="w-full h-24"><path d="M 10 5 L 10 65 L 95 65" fill="none" stroke="gray" stroke-width="1"/><text x="0" y="15" font-size="12">T</text><text x="90" y="60" font-size="12">Q</text><polyline points="10,60 25,50 45,50 75,40 90,40 95,35" fill="none" stroke="#3b82f6" stroke-width="2"/></svg>' },
                    { text: "C", svg: '<svg viewBox="0 0 100 70" class="w-full h-24"><path d="M 10 5 L 10 65 L 95 65" fill="none" stroke="gray" stroke-width="1"/><text x="0" y="15" font-size="12">T</text><text x="90" y="60" font-size="12">Q</text><polyline points="10,60 25,50 45,50 60,20 75,20 95,10" fill="none" stroke="#3b82f6" stroke-width="2"/></svg>' },
                    { text: "D", svg: '<svg viewBox="0 0 100 70" class="w-full h-24"><path d="M 10 5 L 10 65 L 95 65" fill="none" stroke="gray" stroke-width="1"/><text x="0" y="15" font-size="12">T</text><text x="90" y="60" font-size="12">Q</text><polyline points="10,50 30,50 60,20 80,20" fill="none" stroke="#3b82f6" stroke-width="2"/></svg>' },
                ], 
                answer: 1, 
                explanation: "氷の温度上昇（比熱）→ 融解（融解熱で温度一定）→ 水の温度上昇（比熱）→ 蒸発（蒸発熱で温度一定）→ 水蒸気の温度上昇（比熱）という過程をたどります。水の比熱は氷や水蒸気に比べて大きいため、水の温度上昇部分のグラフの傾きは緩やかになります。グラフBがこの特徴を最もよく表しています。"
            },
            { id: 12, topicIndex: 1, group: 'state-change-graph', question: "氷を水にする過程で温度が一定に保たれるのはなぜか。最も適切な理由を述べたものはどれか。", options: ["加えた熱がすべて運動エネルギーに変わるから", "加えた熱がすべて位置エネルギーに変わるから", "加えた熱が分子間の結合を断ち切るために使われるから", "加えた熱が外部に逃げてしまうから", "体積が変化して仕事をするから", "比熱が無限大になるから"], answer: 2, explanation: "融解や蒸発などの状態変化の間、加えられた熱エネルギーは分子の運動エネルギー（=温度）を上昇させるのではなく、分子間の結合を弱めたり断ち切ったりするために使われます。これは分子の位置エネルギーの変化に相当します。このため、状態変化中は温度が一定に保たれます。" },
            { id: 13, topicIndex: 1, group: 'thermal-expansion', question: "多くの物質は温度が上がると体積が増加する（熱膨張）。この現象の主な原因は何か。", options: ["分子の数が増えるから", "分子そのものが大きくなるから", "分子間の引力が強くなるから", "分子の熱運動が激しくなり、平均的な分子間距離が大きくなるから", "物質の密度が大きくなるから", "外部からの圧力が高まるから"], answer: 3, explanation: "温度が上昇すると、物質を構成する原子や分子の熱運動（振動）が激しくなります。その結果、原子・分子間の平均距離が広がり、物質全体として体積が膨張します。これが熱膨張の原理です。" },
            { id: 14, topicIndex: 1, group: 'thermal-expansion', question: "長さ20mの鉄のレールが、温度が10℃から40℃に上昇したとき、どれだけ伸びるか。鉄の線膨張率を \\(1.2 \\times 10^{-5} /K\\) とする。", options: ["0.36 mm", "0.72 mm", "3.6 mm", "7.2 mm", "3.6 cm", "7.2 cm"], answer: 3, explanation: "伸びた長さ \\(\\Delta L\\) は、元の長さ \\(L_0\\)、線膨張率 \\(\\alpha\\)、温度変化 \\(\\Delta T\\) を用いて \\(\\Delta L = L_0 \\alpha \\Delta T\\) と表されます。温度変化は \\(\\Delta T = 40 - 10 = 30\\) K (セルシウス度の差はケルビンの差に等しい)。\\(\\Delta L = 20 \\times (1.2 \\times 10^{-5}) \\times 30 = 7.2 \\times 10^{-3}\\) m。これをmmに直すと \\(7.2\\) mm となります。" },
            { id: 15, topicIndex: 1, group: 'three-states', question: "物質の三態（固体・液体・気体）について、一般的に分子間の距離が最も大きく、分子が最も自由に運動している状態はどれか。", options: ["固体", "液体", "気体", "固体と液体の中間", "液体と気体の臨界点", "すべて同じ"], answer: 2, explanation: "気体状態では、分子は容器内を自由に飛び回り、分子間の距離が固体や液体に比べて非常に大きくなります。そのため、気体は容易に圧縮でき、容器全体の体積を占める性質を持ちます。" },
            { id: 16, topicIndex: 1, group: 'three-states', question: "固体から液体、液体から気体へと状態が変化するとき、一般的に物質の持つ内部エネルギーはどうなるか。", options: ["減少する", "増加する", "変化しない", "一度減少してから増加する", "一度増加してから減少する", "物質による"], answer: 1, explanation: "固体→液体（融解）、液体→気体（蒸発）の変化では、外部から熱を吸収します（吸熱変化）。この吸収した熱は物質の内部エネルギーを増加させるために使われます。したがって、固体＜液体＜気体の順に内部エネルギーは大きくなります。" },
            
            // ===== CORRECTED QUESTION 17 =====
            { id: 17, topicIndex: 2, group: 'first-law-calc', question: "ピストン付きのシリンダーに理想気体を閉じ込め、熱量 \\(500\\,\\mathrm{J}\\) を与えたところ、気体は膨張して外部に \\(200\\,\\mathrm{J}\\) の仕事をした。このときの内部エネルギーの変化 \\(\\Delta U\\) [J] はいくらか。", options: ["-700 J", "-300 J", "0 J", "300 J", "500 J", "700 J"], answer: 3, explanation: "熱力学第一法則の式 \\(\\Delta U = Q + W\\) を用います。\\(Q\\) は気体が受け取った熱量、\\(W\\) は気体がされた仕事です。気体は熱量 \\(500\\,\\mathrm{J}\\) を「与えられた」ので \\(Q = +500 \\, \\mathrm{J}\\)。気体は外部に \\(200 \\, \\mathrm{J}\\) の仕事を「した」ので、された仕事 \\(W\\) は \\(W = -200 \\, \\mathrm{J}\\) となります。よって \\(\\Delta U = 500 + (-200) = 300 \\, \\mathrm{J}\\) となります。" },
            
            { id: 18, topicIndex: 2, group: 'first-law-calc', question: "ある理想気体の内部エネルギーが \\(400\\,\\mathrm{J}\\) 増加した。この過程で気体が外部から \\(150\\,\\mathrm{J}\\) の仕事をされたとすると、気体が吸収または放出した熱量 \\(Q\\) [J] はいくらか。", options: ["250 J 吸収", "250 J 放出", "550 J 吸収", "550 J 放出", "150 J 吸収", "400 J 放出"], answer: 0, explanation: "熱力学第一法則 \\(\\Delta U = Q + W\\) を \\(Q\\) について解くと \\(Q = \\Delta U - W\\) となります。内部エネルギーが \\(400 \, \mathrm{J}\\) 増加したので \\(\\Delta U = +400 \, \mathrm{J}\\)。気体が外部から \\(150 \, \mathrm{J}\\) の仕事を「された」ので \\(W = +150 \, \mathrm{J}\\)。よって \\(Q = 400 - 150 = 250 \, \mathrm{J}\\)。\\(Q\\) が正の値なので、気体は \\(250 \, \mathrm{J}\\) の熱を吸収したことになります。" },
            { id: 19, topicIndex: 2, group: 'internal-energy', question: "理想気体の内部エネルギーについて、正しい記述はどれか。", options: ["体積にのみ比例する", "圧力にのみ比例する", "絶対温度にのみ比例する", "体積と圧力の積に比例する", "物質量に反比例する", "気体の種類によらない"], answer: 2, explanation: "理想気体の分子は分子間力（位置エネルギー）を無視できると仮定されています。そのため、理想気体の内部エネルギーは、全分子の運動エネルギーの総和と等しくなります。そして、分子の平均運動エネルギーは絶対温度にのみ比例するため、理想気体の内部エネルギーも絶対温度にのみ比例します。" },
            { id: 20, topicIndex: 2, group: 'internal-energy', question: "単原子分子理想気体の内部エネルギー \\(U\\) を、物質量 \\(n\\)、気体定数 \\(R\\)、絶対温度 \\(T\\) を用いて表した式はどれか。", options: ["\\(U = \\frac{1}{2}nRT\\)", "\\(U = nRT\\)", "\\(U = \\frac{3}{2}nRT\\)", "\\(U = \\frac{5}{2}nRT\\)", "\\(U = 3nRT\\)", "\\(U = \\frac{3}{2}RT\\)"], answer: 2, explanation: "単原子分子理想気体の内部エネルギーは \\(U = \\frac{3}{2}nRT\\) と表されます。この式は、気体分子の運動エネルギーがx, y, zの3方向の並進運動によるものであることを示しています（エネルギー等分配の法則）。" },
            { id: 21, topicIndex: 2, group: 'work-sign', question: "熱力学第一法則 \\(\\Delta U = Q + W\\) における仕事 \\(W\\) の符号について、正しいものはどれか。", options: ["気体が膨張して外部に仕事をすると \\(W\\) は正", "気体が圧縮されて外部から仕事をされると \\(W\\) は負", "気体が外部に仕事をすると内部エネルギーは増加する", "気体が外部から仕事をされると内部エネルギーは増加する", "仕事の符号は熱量の符号と常に同じ", "仕事は常に正の値をとる"], answer: 3, explanation: "この法則の定義では、\\(W\\) は「気体が外部からされた仕事」を表します。したがって、気体が圧縮される（外部から仕事をされる）とき \\(W > 0\\) となり、内部エネルギーは増加します。逆に、気体が膨張する（外部に仕事をする）とき、された仕事は負になるので \\(W < 0\\) となり、内部エネルギーは減少します。" },
            { id: 22, topicIndex: 2, group: 'work-sign', question: "気体をピストンで圧縮した。このとき、気体がされた仕事 \\(W\\) と内部エネルギーの変化 \\(\\Delta U\\) はどうなるか。ただし、熱の出入りはないもの（断熱変化）とする。", options: ["\\(W > 0, \\Delta U > 0\\)", "\\(W > 0, \\Delta U < 0\\)", "\\(W < 0, \\Delta U > 0\\)", "\\(W < 0, \\Delta U < 0\\)", "\\(W = 0, \\Delta U = 0\\)", "\\(W > 0, \\Delta U = 0\\)"], answer: 0, explanation: "気体を圧縮したので、外部から仕事をされています。よって \\(W > 0\\) です。断熱変化では熱の出入りがないので \\(Q = 0\\) です。熱力学第一法則 \\(\\Delta U = Q + W\\) に代入すると、\\(\\Delta U = 0 + W = W\\) となります。\\(W > 0\\) なので、\\(\\Delta U > 0\\) となり、内部エネルギーは増加します（温度が上昇します）。" },
            { id: 23, topicIndex: 2, group: 'first-law-process', question: "ある理想気体を定圧（圧力を一定に保ちながら）で膨張させた。このとき、気体に加えられた熱量 \\(Q\\) は何に使われたか。", options: ["内部エネルギーの増加にのみ使われた", "外部への仕事にのみ使われた", "内部エネルギーの増加と、外部への仕事の両方に使われた", "内部エネルギーの減少と、外部への仕事の両方に使われた", "熱量は加えられていない", "内部エネルギーは変化しなかった"], answer: 2, explanation: "定圧膨張では、体積が増加するため気体は外部に正の仕事をします（\\(W' > 0 \\Rightarrow W < 0\\)）。また、理想気体の温度はシャルルの法則により体積に比例して上昇するため、内部エネルギーも増加します（\\(\\Delta U > 0\\)）。熱力学第一法則 \\(Q = \\Delta U - W\\) より、加えられた熱量 \\(Q\\) は、内部エネルギーの増加と外部への仕事の両方に使われたことがわかります。" },
            { id: 24, topicIndex: 2, group: 'first-law-process', question: "理想気体を体積一定のまま加熱した（定積変化）。このとき、熱力学第一法則はどうなるか。", options: ["\\(\\Delta U = Q\\)", "\\(\\Delta U = W\\)", "\\(Q = -W\\)", "\\(\\Delta U = 0\\)", "\\(Q = 0\\)", "\\(W = 0\\)"], answer: 0, explanation: "定積変化では体積が変化しないため、気体は外部に対して仕事をしませんし、外部から仕事もされません。したがって \\(W = 0\\) です。これを熱力学第一法則 \\(\\Delta U = Q + W\\) に代入すると、\\(\\Delta U = Q\\) となります。これは、加えられた熱量がすべて内部エネルギーの増加に使われたことを意味します。" },
            { id: 25, topicIndex: 3, group: 'heat-engine', question: "熱機関が高温熱源から熱量 \\(Q_1\\) を受け取り、仕事 \\(W'\\) をして、低温熱源に熱量 \\(Q_2\\) を放出した。この熱機関の熱効率 \\(e\\) を表す式として、正しいものはどれか。", options: ["\\(e = \\frac{W'}{Q_2}\\)", "\\(e = \\frac{Q_2}{Q_1}\\)", "\\(e = \\frac{W'}{Q_1}\\)", "\\(e = \\frac{Q_1}{W'}\\)", "\\(e = 1 - \\frac{Q_1}{Q_2}\\)", "\\(e = \\frac{Q_1 - W'}{Q_1}\\)"], answer: 2, explanation: "熱効率 \\(e\\) は、受け取った熱量 \\(Q_1\\) のうち、どれだけの割合を仕事 \\(W'\\) に変換できたかを表す指標です。したがって、定義式は \\(e = \\frac{W'}{Q_1}\\) となります。また、エネルギー保存則より \\(Q_1 = W' + Q_2\\) なので、\\(W' = Q_1 - Q_2\\) を代入すると \\(e = \\frac{Q_1 - Q_2}{Q_1} = 1 - \\frac{Q_2}{Q_1}\\) とも表せます。" },
            { id: 26, topicIndex: 3, group: 'heat-engine', question: "ある熱機関が、高温熱源から1000Jの熱を吸収し、低温熱源へ600Jの熱を放出した。この熱機関がした仕事 \\(W'\\) [J] と熱効率 \\(e\\) はいくらか。", options: ["\\(W'=400, e=0.6\\)", "\\(W'=600, e=0.6\\)", "\\(W'=1600, e=1.6\\)", "\\(W'=400, e=0.4\\)", "\\(W'=600, e=0.4\\)", "\\(W'=1000, e=1.0\\)"], answer: 3, explanation: "エネルギー保存則より、した仕事 \\(W'\\) は \\(W' = Q_1 - Q_2 = 1000 - 600 = 400\\) J。熱効率 \\(e\\) は \\(e = \\frac{W'}{Q_1} = \\frac{400}{1000} = 0.4\\) となります。" },
            { id: 27, topicIndex: 3, group: 'irreversible', question: "不可逆変化の例として、最も適切なものはどれか。", options: ["ゆっくりとピストンを動かす断熱圧縮", "摩擦のない振り子の運動", "インクが水の中で自然に広がっていく現象", "理想気体の等温変化", "惑星の公転運動", "ばねの単振動"], answer: 2, explanation: "不可逆変化とは、外部から特別な操作をしない限り、自然には元の状態に戻らない変化のことです。インクが一度水に広がると、自然に集まって一滴に戻ることはありません。他の選択肢は、理想的な条件下では元の状態に戻る可逆変化と見なせます。" },
            { id: 28, topicIndex: 3, group: 'irreversible', question: "熱力学第二法則に関する記述として、誤っているものはどれか。", options: ["熱は自然に高温物体から低温物体へ移動するが、その逆は自然には起こらない", "外部から仕事をしない限り、熱を低温の物体から高温の物体へ移すことはできない", "すべての熱を仕事に変えることができる熱機関（第二種永久機関）は存在しない", "孤立した系では、エントロピーは増大する方向に変化する", "熱効率100%の熱機関は理論的に可能である", "不可逆変化ではエントロピーが増大する"], answer: 4, explanation: "熱力学第二法則は、熱現象の不可逆性を説明する法則です。この法則により、受け取った熱 \\(Q_1\\) をすべて仕事 \\(W'\\) に変換する（低温熱源に熱を捨てない \\(Q_2=0\\)）熱機関は存在し得ません。したがって、熱効率が1 (100%) になることはありません。選択肢5は誤りです。" },
            { id: 29, topicIndex: 3, group: 'heat-pump', question: "冷蔵庫やエアコンの原理であるヒートポンプに関する記述として、正しいものはどれか。", options: ["熱を仕事に変える装置である", "低温部分から熱を奪い、高温部分へ熱を移動させる装置である", "外部から仕事を加える必要はない", "ヒートポンプを動かすと、放出する熱量より吸収する熱量の方が多い", "COP(成績係数)は常に1より小さい", "熱力学第一法則に反している"], answer: 1, explanation: "ヒートポンプは、熱機関の逆の働きをする装置です。外部から仕事 \\(W\\) を加えることで、低温の熱源から熱 \\(Q_2\\) を吸収し、高温の熱源へ熱 \\(Q_1\\) を放出します。エネルギー保存則 \\(Q_1 = Q_2 + W\\) が成り立ちます。" },
            { id: 30, topicIndex: 3, group: 'heat-pump', question: "ドアを開けっ放しにした冷蔵庫を運転し続けると、部屋の温度はどうなるか。", options: ["下がる", "上がる", "変わらない", "一度下がってから上がる", "一度上がってから下がる", "冷蔵庫の性能による"], answer: 1, explanation: "冷蔵庫は庫内から熱を奪い、外部（部屋）に放出します。このとき、コンプレッサーを動かすための仕事（電気エネルギー）が加わります。エネルギー保存則から、放出する熱量 = 庫内から奪った熱量 + 仕事 となり、差し引きで部屋全体には熱が放出されるため、部屋の温度は上がります。" },
            { id: 31, topicIndex: 4, group: 'ideal-gas-law', question: "圧力 \\(p\\)、体積 \\(V\\)、物質量 \\(n\\)、気体定数 \\(R\\)、絶対温度 \\(T\\) の間の関係を示す理想気体の状態方程式として正しいものはどれか。", options: ["\\(pV = nT\\)", "\\(pT = nRV\\)", "\\(pV = nRT\\)", "\\(p/V = nRT\\)", "\\(V/T = pR\\)", "\\(p V / T = n\\)"], answer: 2, explanation: "理想気体の状態方程式は \\(pV = nRT\\) で表されます。これはボイルの法則、シャルルの法則、アボガドロの法則を組み合わせたものです。" },
            { id: 32, topicIndex: 4, group: 'ideal-gas-law', question: "27℃、\\(1.0 \\times 10^5\\) Paで、体積が \\(24.9 \\times 10^{-3} m^3\\) の理想気体の物質量 \\(n\\) [mol] はいくらか。気体定数を \\(R = 8.3\\) J/(mol·K)とする。", options: ["0.1 mol", "0.5 mol", "1.0 mol", "2.0 mol", "10 mol", "300 mol"], answer: 2, explanation: "理想気体の状態方程式 \\(pV = nRT\\) を \\(n\\) について解くと \\(n = pV / RT\\) となります。まず、温度を絶対温度に変換します: \\(T = 27 + 273 = 300\\) K。値を代入すると、\\(n = (1.0 \\times 10^5 \\times 24.9 \\times 10^{-3}) / (8.3 \\times 300) = (100 \\times 24.9) / (8.3 \\times 300) = 2490 / 2490 = 1.0\\) mol。" },
            { id: 33, topicIndex: 4, group: 'gas-laws', question: "温度が一定のとき、一定量の気体の体積は圧力に反比例するという法則を何というか。", options: ["シャルルの法則", "ボイルの法則", "アボガドロの法則", "ドルトンの分圧の法則", "ゲイ＝リュサックの法則", "ヘンリーの法則"], answer: 1, explanation: "これはボイルの法則です。式で表すと \\(pV = \\text{一定}\\) となります。温度が一定の条件下で、圧力を2倍にすると体積は1/2になります。" },
            { id: 34, topicIndex: 4, group: 'gas-laws', question: "27℃で2.0Lだった気球を、圧力を一定に保ったまま127℃まで熱した。体積は何Lになるか。", options: ["1.5 L", "2.0 L", "2.7 L", "4.0 L", "6.0 L", "8.0 L"], answer: 2, explanation: "圧力が一定なので、シャルルの法則 \\(V/T = \\text{一定}\\) を使います。温度は絶対温度で計算する必要があります。\\(T_1 = 27 + 273 = 300\\) K, \\(T_2 = 127 + 273 = 400\\) K。\\(V_1/T_1 = V_2/T_2\\) より、\\(2.0 / 300 = V_2 / 400\\)。これを解くと \\(V_2 = 2.0 \\times 400 / 300 = 8/3 \\approx 2.67\\) L。選択肢の2.7Lが最も近いです。" },
            
            // ===== CORRECTED QUESTION 35 =====
            { 
                id: 35, topicIndex: 4, group: 'pv-graph', 
                question: "理想気体を断熱的に圧縮したとき、p-Vグラフ上の状態はどのように変化するか。図中の点線は等温線を表す。", 
                options: [
                    { 
                        text: "A: 等温線に沿って移動する", 
                        svg: `<svg viewBox="0 0 100 70" class="w-full h-24">
                                <path d="M 10 5 L 10 65 L 95 65" fill="none" stroke="gray" stroke-width="1"/>
                                <text x="0" y="15" font-size="12">P</text><text x="90" y="60" font-size="12">V</text>
                                <path d="M 85 60 Q 45 40 25 25" stroke-dasharray="4" stroke="gray" fill="none" stroke-width="1.5"/>
                                <path d="M 90 45 Q 55 25 35 10" stroke-dasharray="4" stroke="gray" fill="none" stroke-width="1.5"/>
                                <path d="M 85 60 Q 45 40 25 25" stroke="#3b82f6" stroke-width="2" fill="none" marker-end="url(#arrowA)"/>
                                <defs><marker id="arrowA" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" fill="#3b82f6"/></marker></defs>
                              </svg>`
                    },
                    { 
                        text: "B: 等温線より傾きが急な曲線で移動", 
                        svg: `<svg viewBox="0 0 100 70" class="w-full h-24">
                                <path d="M 10 5 L 10 65 L 95 65" fill="none" stroke="gray" stroke-width="1"/>
                                <text x="0" y="15" font-size="12">P</text><text x="90" y="60" font-size="12">V</text>
                                <path d="M 85 60 Q 45 40 25 25" stroke-dasharray="4" stroke="gray" fill="none" stroke-width="1.5"/>
                                <path d="M 90 45 Q 55 25 35 10" stroke-dasharray="4" stroke="gray" fill="none" stroke-width="1.5"/>
                                <path d="M 85 60 Q 65 30 45 15" stroke="#3b82f6" stroke-width="2" fill="none" marker-end="url(#arrowB)"/>
                                <defs><marker id="arrowB" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" fill="#3b82f6"/></marker></defs>
                              </svg>`
                    },
                    { 
                        text: "C: 等温線より傾きが緩やかな曲線で移動", 
                        svg: `<svg viewBox="0 0 100 70" class="w-full h-24">
                                <path d="M 10 5 L 10 65 L 95 65" fill="none" stroke="gray" stroke-width="1"/>
                                <text x="0" y="15" font-size="12">P</text><text x="90" y="60" font-size="12">V</text>
                                <path d="M 85 60 Q 45 40 25 25" stroke-dasharray="4" stroke="gray" fill="none" stroke-width="1.5"/>
                                <path d="M 90 45 Q 55 25 35 10" stroke-dasharray="4" stroke="gray" fill="none" stroke-width="1.5"/>
                                <path d="M 85 60 Q 55 55 30 40" stroke="#3b82f6" stroke-width="2" fill="none" marker-end="url(#arrowC)"/>
                                <defs><marker id="arrowC" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" fill="#3b82f6"/></marker></defs>
                              </svg>`
                    },
                    { 
                        text: "D: 垂直に移動する（定積）", 
                        svg: `<svg viewBox="0 0 100 70" class="w-full h-24">
                                <path d="M 10 5 L 10 65 L 95 65" fill="none" stroke="gray" stroke-width="1"/>
                                <text x="0" y="15" font-size="12">P</text><text x="90" y="60" font-size="12">V</text>
                                <path d="M 85 60 Q 45 40 25 25" stroke-dasharray="4" stroke="gray" fill="none" stroke-width="1.5"/>
                                <path d="M 90 45 Q 55 25 35 10" stroke-dasharray="4" stroke="gray" fill="none" stroke-width="1.5"/>
                                <path d="M 60 60 L 60 20" stroke="#3b82f6" stroke-width="2" fill="none" marker-end="url(#arrowD)"/>
                                <defs><marker id="arrowD" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" transform="rotate(-90 5 5)" fill="#3b82f6"/></marker></defs>
                              </svg>`
                    }
                ],
                answer: 1, 
                explanation: "断熱変化では熱の出入りがない（\\(Q=0\\)）ため、圧縮（\\(W>0\\)）されると内部エネルギーが増加し、温度が上昇します。そのため、出発点の等温線からより温度の高い（より右上にある）等温線へと移っていきます。このときの経路（断熱線）は、等温線（反比例のグラフ、\\(pV=\\text{const.}\\)）よりも傾きが急な曲線（\\(pV^\\gamma=\\text{const.}\\)）になります。したがってBが正解です。" 
            },
            // ===== END OF CORRECTION =====

            // Questions 36-46 are unchanged
            { id: 36, topicIndex: 4, group: 'pv-graph', question: "p-Vグラフで囲まれたサイクル（A→B→C→A）において、グラフで囲まれた部分の面積が表す物理量は何か。", options: ["内部エネルギーの変化", "気体が吸収した総熱量", "気体が放出した総熱量", "1サイクルで気体が外部にした正味の仕事", "1サイクルでのエントロピーの変化", "気体のモル数"], answer: 3, explanation: "p-Vグラフにおいて、過程の曲線とV軸で囲まれた面積は、その過程で気体がした仕事を表します。時計回りのサイクルでは、膨張過程の仕事（正）が圧縮過程の仕事（負）より大きいため、差し引きで正味の仕事を外部に行います。この正味の仕事の大きさが、サイクルで囲まれた部分の面積に等しくなります。" },
            { id: 37, topicIndex: 4, group: 'molar-specific-heat', question: "単原子分子理想気体の定積モル比熱 \\(C_V\\) はいくらか。気体定数を \\(R\\) とする。", options: ["\\(\\frac{1}{2}R\\)", "\\(R\\)", "\\(\\frac{3}{2}R\\)", "\\(\\frac{5}{2}R\\)", "\\(3R\\)", "気体の種類による"], answer: 2, explanation: "定積変化では加えられた熱がすべて内部エネルギーの増加に使われます (\\(Q = \\Delta U\\))。1モルの気体を1K上昇させる場合、\\(C_V = \\Delta U = \\frac{3}{2}R(T+1) - \\frac{3}{2}RT = \\frac{3}{2}R\\) となります。" },
            { id: 38, topicIndex: 4, group: 'molar-specific-heat', question: "定圧モル比熱 \\(C_p\\) と定積モル比熱 \\(C_V\\) の間には、\\(C_p - C_V = R\\) という関係（マイヤーの関係）が成り立つ。単原子分子理想気体の定圧モル比熱 \\(C_p\\) はいくらか。", options: ["\\(\\frac{1}{2}R\\)", "\\(R\\)", "\\(\\frac{3}{2}R\\)", "\\(\\frac{5}{2}R\\)", "\\(3R\\)", "計算できない"], answer: 3, explanation: "単原子分子理想気体の定積モル比熱は \\(C_V = \\frac{3}{2}R\\) です。マイヤーの関係式 \\(C_p = C_V + R\\) に代入すると、\\(C_p = \\frac{3}{2}R + R = \\frac{5}{2}R\\) となります。" },
            { id: 39, topicIndex: 5, group: 'kinetic-theory', question: "気体分子の運動に関する記述として、正しいものはどれか。", options: ["気体の圧力は、分子同士の衝突によって生じる", "気体分子の平均運動エネルギーは、圧力に比例する", "気体の温度を上げると、分子の平均の速さは小さくなる", "気体分子の平均運動エネルギーは、気体の種類によらず絶対温度に比例する", "すべての分子は同じ速さで運動している", "分子の質量が大きいほど、同じ温度での平均の速さは大きい"], answer: 3, explanation: "気体分子の運動論によれば、分子の平均運動エネルギーは \\(\\frac{1}{2}m\\overline{v^2} = \\frac{3}{2}kT\\) と表され、絶対温度 \\(T\\) にのみ比例します（\\(k\\) はボルツマン定数）。これは気体の種類（分子量 \\(m\\)）にはよりません。また、圧力は分子が容器の壁に衝突することによって生じます。" },
            { id: 40, topicIndex: 5, group: 'kinetic-theory', question: "絶対温度が2倍になると、気体分子の二乗平均速度は何倍になるか。", options: ["1/2倍", "\\(1/\\sqrt{2}\\)倍", "変化しない", "\\(\\sqrt{2}\\)倍", "2倍", "4倍"], answer: 3, explanation: "分子の平均運動エネルギーは \\(\\frac{1}{2}m\\overline{v^2}\\) で、これは絶対温度 \\(T\\) に比例します。つまり \\(\\overline{v^2} \\propto T\\) です。したがって、二乗平均速度 \\(\\sqrt{\\overline{v^2}}\\) は \\(\\sqrt{T}\\) に比例します。温度 \\(T\\) が2倍になると、二乗平均速度は \\(\\sqrt{2}\\) 倍になります。" },
            { id: 41, topicIndex: 5, group: 'pressure-origin', question: "気体の圧力が発生する主な原因として、最も適切なものはどれか。", options: ["気体分子同士が衝突するため", "気体分子が容器の壁に衝突するため", "気体分子が重力で落下するため", "気体分子間の引力のため", "気体分子がブラウン運動するため", "気体分子が蒸発するため"], answer: 1, explanation: "気体の圧力は、多数の気体分子が絶えず運動し、容器の壁に衝突することによって壁に及ぼす力として現れます。衝突の頻度や強さが高いほど、圧力は高くなります。" },
            { id: 42, topicIndex: 5, group: 'pressure-origin', question: "気体の圧力を高める方法として、適切でないものはどれか。ただし、物質量は一定とする。", options: ["温度を上げる", "容器の体積を小さくする", "分子の運動エネルギーを大きくする", "容器の体積を大きくする", "壁への衝突頻度を増やす", "壁への一個あたりの衝突の力積を大きくする"], answer: 3, explanation: "理想気体の状態方程式 \\(pV=nRT\\) より、圧力 \\(p = nRT/V\\) です。物質量 \\(n\\) が一定のとき、温度 \\(T\\) を上げるか、体積 \\(V\\) を小さくすると圧力 \\(p\\) は高まります。体積を大きくすると圧力は下がります。" },
            { id: 43, topicIndex: 5, group: 'internal-energy-kinetic', question: "理想気体の内部エネルギーが、気体分子の何と等しいとされているか。", options: ["全分子の運動エネルギーの総和", "全分子の位置エネルギーの総和", "分子1個あたりの運動エネルギー", "分子間にはたらく力によるエネルギー", "気体の持つ熱量", "気体が外部にした仕事"], answer: 0, explanation: "理想気体では、分子間にはたらく力（分子間力）を無視するため、位置エネルギーは0と考えます。したがって、内部エネルギーは全ての分子が持つ運動エネルギーの合計（ストック）と定義されます。選択肢の「気体の持つ熱量」は誤りです。熱は物体が持つものではなく、エネルギーの移動形態（フロー）だからです。" },
            { id: 44, topicIndex: 5, group: 'internal-energy-kinetic', question: "温度が一定の理想気体の体積を2倍にした（等温膨張）。内部エネルギーはどうなるか。", options: ["2倍になる", "1/2になる", "増加する", "減少する", "変化しない", "0になる"], answer: 4, explanation: "理想気体の内部エネルギーは、絶対温度にのみ比例します。したがって、温度が一定である限り、体積や圧力が変化しても内部エネルギーは変化しません。" },
            { id: 45, topicIndex: 5, group: 'boltzmann-constant', question: "気体分子1個の平均運動エネルギーは、ボルツマン定数 \\(k\\) と絶対温度 \\(T\\) を用いてどのように表されるか。", options: ["\\(\\frac{1}{2}kT\\)", "\\(kT\\)", "\\(\\frac{3}{2}kT\\)", "\\(\\frac{5}{2}kT\\)", "\\(3kT\\)", "\\(k/T\\)"], answer: 2, explanation: "単原子分子理想気体の場合、分子1個あたりの平均運動エネルギーは \\(\\frac{1}{2}m\\overline{v^2} = \\frac{3}{2}kT\\) と表されます。ここで \\(k\\) はボルツマン定数です。" },
            { id: 46, topicIndex: 5, group: 'boltzmann-constant', question: "アボガドロ定数 \\(N_A\\)、気体定数 \\(R\\)、ボルツマン定数 \\(k\\) の間の関係式として正しいものはどれか。", options: ["\\(k = N_A R\\)", "\\(R = N_A k\\)", "\\(N_A = R k\\)", "\\(R = N_A / k\\)", "\\(k = R / N_A\\)", "\\(R=k\\)"], answer: 1, explanation: "気体定数 \\(R\\) は1モルあたりの気体のエネルギーに関する定数、ボルツマン定数 \\(k\\) は分子1個あたりのエネルギーに関する定数です。1モルにはアボガドロ定数 \\(N_A\\) 個の分子が含まれるため、\\(R = N_A k\\) という関係が成り立ちます。選択肢5も同じ意味ですが、一般的に \\(R = N_A k\\) と表記されます。" },
        ]
    },

    // Initialization
    init() {
        this.elements.startBtn.addEventListener('click', () => this.startQuiz());
        this.elements.teacherModeBtn.addEventListener('click', () => this.startTeacherMode());
        this.elements.checkAnswerBtn.addEventListener('click', () => this.checkAnswer());
        this.elements.endQuizBtn.addEventListener('click', () => this.generateReport());
        this.elements.exitTeacherModeBtn.addEventListener('click', () => this.returnToStart());
        this.elements.loadProgressInput.addEventListener('change', (e) => this.loadProgress(e));
        this.elements.loadReportInput.addEventListener('change', (e) => this.loadReport(e));
        this.elements.saveProgressBtn.addEventListener('click', () => {
            this.saveProgress();
            this.returnToStart();
        });
        this.elements.reviewBtn.addEventListener('click', () => this.startReview());
        this.elements.restartBtn.addEventListener('click', () => {
            this.elements.modalOverlay.style.display = 'none';
        });

        this.renderTOC();
    },

    // Start the quiz for students
    startQuiz(isLoaded = false) {
        this.state.isTeacherMode = false;
        if (!isLoaded) {
            this.state.studentId = this.elements.studentIdInput.value;
            this.state.studentName = this.elements.studentNameInput.value;
            if (!this.state.studentId || !this.state.studentName) {
                alert('出席番号と名前を入力してください。');
                return;
            }
            this.state.startedAt = new Date().toISOString();
            this.state.resumedHistory = [];
            this.state.currentTopicIndex = 0;
            this.state.usedQuestionIds.clear();
            this.initializeReportData();
        }
        this.elements.modalOverlay.style.display = 'none';
        this.updateUIVisibility();
        this.loadTopic(this.state.currentTopicIndex);
    },

    // NEW: Start in teacher mode
    startTeacherMode() {
        this.state.isTeacherMode = true;
        this.state.teacherModeHistory.push(new Date().toISOString()); // NEW: Track access
        this.elements.modalOverlay.style.display = 'none';
        this.updateUIVisibility();
        this.renderTOC();
        // Jump to the first question by default
        this.jumpToQuestion(1);
    },
    
    // NEW: Jump to a specific question
    jumpToQuestion(questionId) {
        const q = this.data.questions.find(q => q.id === questionId);
        if (q) {
            this.state.currentQuestion = q;
            this.state.currentTopicIndex = q.topicIndex;
            
            this.elements.modalOverlay.style.display = 'none';
            this.state.selectedAnswerIndex = null;
            this.displayQuestion();
        }
    },
    
    // NEW: Jump to the next question in the list (for teacher mode)
    jumpToNextQuestion() {
        const currentIndex = this.data.questions.findIndex(q => q.id === this.state.currentQuestion.id);
        const nextIndex = (currentIndex + 1) % this.data.questions.length;
        const nextQuestionId = this.data.questions[nextIndex].id;
        this.jumpToQuestion(nextQuestionId);
    },

    // NEW: Update UI elements based on the mode
    updateUIVisibility() {
        if (this.state.isTeacherMode) {
            this.elements.modeIndicator.textContent = '先生モード';
            this.elements.endQuizBtn.style.display = 'none';
            this.elements.exitTeacherModeBtn.style.display = 'block';
            this.elements.understandingButtons.style.display = 'none';
            this.elements.teacherNextButtons.style.display = 'block';
            this.elements.tocTitle.textContent = '問題一覧';
        } else {
            this.elements.modeIndicator.textContent = '';
            this.elements.endQuizBtn.style.display = 'block';
            this.elements.exitTeacherModeBtn.style.display = 'none';
            this.elements.understandingButtons.style.display = 'block';
            this.elements.teacherNextButtons.style.display = 'none';
            this.elements.tocTitle.textContent = '目次';
        }
    },

    // Save progress to a JSON file
    saveProgress() {
        this.state.saveHistory.push(new Date().toISOString()); // NEW: Track save time
        const saveData = {
            studentId: this.state.studentId,
            studentName: this.state.studentName,
            startedAt: this.state.startedAt,
            resumedHistory: this.state.resumedHistory,
            savedAt: new Date().toISOString(),
            currentTopicIndex: this.state.currentTopicIndex,
            currentGroupIndex: this.state.currentGroupIndex,
            topicGroups: this.state.topicGroups,
            usedQuestionIds: Array.from(this.state.usedQuestionIds),
            reportData: this.state.reportData,
            teacherModeHistory: this.state.teacherModeHistory, 
            saveHistory: this.state.saveHistory, // NEW: Save history
        };
        const blob = new Blob([JSON.stringify(saveData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const studentId = this.state.studentId || 'id';
        const studentName = this.state.studentName || 'name';
        const date = new Date().toISOString().slice(0, 10);
        a.href = url;
        a.download = `${studentId}_${studentName}_physics-progress_${date}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    },

    // Load progress from a JSON file to resume quiz
    loadProgress(event) {
        this.loadAndProcessFile(event, true);
    },

    // Load progress from a JSON file to just show the report
    loadReport(event) {
        this.loadAndProcessFile(event, false);
    },

    loadAndProcessFile(event, startQuizAfterLoad) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const loadedData = JSON.parse(e.target.result);
                // Basic validation
                if (loadedData.reportData && loadedData.usedQuestionIds && loadedData.studentId) {
                    this.state.studentId = loadedData.studentId;
                    this.state.studentName = loadedData.studentName;
                    this.state.startedAt = loadedData.startedAt || new Date().toISOString();
                    this.state.resumedHistory = loadedData.resumedHistory || [];
                    this.state.currentTopicIndex = loadedData.currentTopicIndex;
                    this.state.currentGroupIndex = loadedData.currentGroupIndex;
                    this.state.topicGroups = loadedData.topicGroups;
                    this.state.usedQuestionIds = new Set(loadedData.usedQuestionIds);
                    this.state.reportData = loadedData.reportData;
                    this.state.teacherModeHistory = loadedData.teacherModeHistory || []; 
                    this.state.saveHistory = loadedData.saveHistory || []; // NEW: Load history
                    
                    this.elements.studentIdInput.value = this.state.studentId;
                    this.elements.studentNameInput.value = this.state.studentName;

                    if (startQuizAfterLoad) {
                        this.state.resumedHistory.push(new Date().toISOString());
                        this.startQuiz(true);
                    } else {
                        this.generateReport();
                    }
                } else {
                    alert('無効なファイル形式です。');
                }
            } catch (error) {
                alert('ファイルの読み込みに失敗しました。');
                console.error("Failed to parse progress file:", error);
            }
        };
        reader.readAsText(file);
        // Reset file input to allow loading the same file again
        event.target.value = '';
    },

    // Initialize report data structure
    initializeReportData() {
        this.data.topics.forEach(topic => {
            const topicQuestions = this.data.questions.filter(q => q.topicIndex === this.data.topics.indexOf(topic));
            const uniqueGroups = [...new Set(topicQuestions.map(q => q.group))];
            this.state.reportData[topic] = {
                mistakes: 0,
                attempts: 0,
                completedGroups: 0,
                totalGroups: uniqueGroups.length,
                understoodCount: 0,
                notUnderstoodCount: 0,
                notUnderstoodQuestions: [],
                reviewAttempts: 0,
                reviewMistakes: 0,
                reviewUnderstoodCount: 0,
                reviewNotUnderstoodCount: 0,
            };
        });
        this.state.saveHistory = []; // NEW: Reset save history
        this.state.teacherModeHistory = []; // NEW: Reset teacher mode history
    },

    // Load a new topic
    loadTopic(topicIndex) {
        this.state.currentTopicIndex = topicIndex;
        // If not starting from a loaded state, shuffle the groups for the new topic
        if (!this.state.topicGroups || this.state.topicGroups.length === 0) {
            const topicQuestions = this.data.questions.filter(q => q.topicIndex === topicIndex);
            const uniqueGroups = [...new Set(topicQuestions.map(q => q.group))];
            this.state.topicGroups = this.shuffleArray(uniqueGroups);
            this.state.currentGroupIndex = 0;
        }
        this.loadQuestion();
    },

    // Load a question from the current topic and group
    loadQuestion() {
        // If all groups in the current topic are done, move to the next topic
        if (this.state.currentGroupIndex >= this.state.topicGroups.length) {
            this.state.currentTopicIndex++;
            this.state.topicGroups = []; // Reset groups for the next topic
            if (this.state.currentTopicIndex >= this.data.topics.length) {
                this.generateReport();
                return;
            } else {
                this.loadTopic(this.state.currentTopicIndex);
                return;
            }
        }

        const groupName = this.state.topicGroups[this.state.currentGroupIndex];
        
        const availableQuestions = this.data.questions.filter(q => 
            q.topicIndex === this.state.currentTopicIndex &&
            q.group === groupName &&
            !this.state.usedQuestionIds.has(q.id)
        );

        if (availableQuestions.length > 0) {
            this.state.currentQuestion = availableQuestions[0];
            this.state.usedQuestionIds.add(this.state.currentQuestion.id);
            this.displayQuestion();
        } else {
            // This case happens if a user fails a concept twice. We force advance.
            this.advance(true);
        }
    },

    // Display the current question
    displayQuestion() {
        const q = this.state.currentQuestion;
        this.elements.currentTopicTitle.textContent = this.data.topics[q.topicIndex];
        this.elements.questionText.innerHTML = q.question;
        this.elements.optionsGrid.innerHTML = '';
        
        q.options.forEach((option, index) => {
            const button = document.createElement('button');
            button.className = 'option-btn w-full text-left p-3 border-2 border-gray-300 rounded-lg hover:bg-blue-50 flex flex-col items-center justify-center space-y-2';
            
            if (typeof option === 'object' && option.svg) {
                button.innerHTML = `<span>${option.text}</span>${option.svg}`;
            } else {
                button.innerHTML = `<span>${option}</span>`;
            }

            button.onclick = () => this.selectAnswer(index);
            this.elements.optionsGrid.appendChild(button);
        });

        this.elements.checkAnswerBtn.disabled = true;
        this.elements.questionArea.style.display = 'block';
        this.elements.explanationArea.style.display = 'none';
        
        this.renderTOC();
        this.renderKaTeX();
    },

    // Handle answer selection
    selectAnswer(index) {
        this.state.selectedAnswerIndex = index;
        const buttons = this.elements.optionsGrid.querySelectorAll('button');
        buttons.forEach((btn, i) => {
            btn.classList.toggle('selected', i === index);
        });
        this.elements.checkAnswerBtn.disabled = false;
    },

    // Check the selected answer
    checkAnswer() {
        if (this.state.selectedAnswerIndex === null) return;
        const q = this.state.currentQuestion;
        const isCorrect = this.state.selectedAnswerIndex === q.answer;
        this.state.answeredCorrectly = isCorrect;

        if (!this.state.isTeacherMode) {
            const topicName = this.data.topics[q.topicIndex];
            if (this.state.isReviewMode) {
                this.state.reportData[topicName].reviewAttempts++;
                if (!isCorrect) this.state.reportData[topicName].reviewMistakes++;
            } else {
                this.state.reportData[topicName].attempts++;
                if (!isCorrect) this.state.reportData[topicName].mistakes++;
            }
        }

        this.showExplanation();
    },

    // Show explanation and feedback buttons
    showExplanation() {
        const q = this.state.currentQuestion;
        this.elements.questionArea.style.display = 'none';
        this.elements.explanationArea.style.display = 'block';

        this.elements.resultTitle.textContent = this.state.answeredCorrectly ? '正解！' : '不正解';
        this.elements.explanationArea.className = this.state.answeredCorrectly 
            ? 'mt-6 bg-white p-6 md:p-8 rounded-xl shadow-lg border-t-8 border-green-500'
            : 'mt-6 bg-white p-6 md:p-8 rounded-xl shadow-lg border-t-8 border-red-500';
        
        const correctAnswer = q.options[q.answer];
        if (typeof correctAnswer === 'object' && correctAnswer.svg) {
            this.elements.correctAnswerText.innerHTML = `<span>${correctAnswer.text}</span>${correctAnswer.svg}`;
        } else {
            this.elements.correctAnswerText.innerHTML = `<span>${correctAnswer}</span>`;
        }

        this.elements.explanationText.innerHTML = q.explanation;
        this.renderKaTeX();
    },

    // Handle "understood" or "not understood" feedback
    handleUnderstanding(understood) {
        const topicName = this.data.topics[this.state.currentQuestion.topicIndex];
        const questionId = this.state.currentQuestion.id;

        if (this.state.isReviewMode) {
            if (understood) {
                this.state.reportData[topicName].reviewUnderstoodCount++;
            } else {
                this.state.reportData[topicName].reviewNotUnderstoodCount++;
            }
        } else {
            const notUnderstoodList = this.state.reportData[topicName].notUnderstoodQuestions;
            if (understood) {
                this.state.reportData[topicName].understoodCount++;
                const index = notUnderstoodList.indexOf(questionId);
                if (index > -1) notUnderstoodList.splice(index, 1);
            } else {
                this.state.reportData[topicName].notUnderstoodCount++;
                if (!notUnderstoodList.includes(questionId)) {
                    notUnderstoodList.push(questionId);
                }
            }
        }

        if (this.state.isReviewMode) {
            this.loadNextReviewQuestion();
        } else {
            const success = this.state.answeredCorrectly && understood;
            this.advance(success);
        }
    },

    // Advance to the next question/topic
    advance(success) {
        if (success) {
            const topicName = this.data.topics[this.state.currentTopicIndex];
            this.state.reportData[topicName].completedGroups++;
            this.state.currentGroupIndex++;
        }
        
        this.loadQuestion();
    },

    // Review Mode Logic
    startReview() {
        this.state.isReviewMode = true;
        let reviewQueue = [];
        this.data.topics.forEach(topicName => {
            const topicData = this.state.reportData[topicName];
            if (topicData.notUnderstoodQuestions && topicData.notUnderstoodQuestions.length > 0) {
                reviewQueue = reviewQueue.concat(topicData.notUnderstoodQuestions);
            }
        });

        this.state.reviewQueue = this.shuffleArray(reviewQueue);
        this.elements.modalOverlay.style.display = 'none';
        this.elements.sidebar.style.display = 'none';
        this.elements.modeIndicator.textContent = '復習モード';
        this.loadNextReviewQuestion();
    },

    loadNextReviewQuestion() {
        if (this.state.reviewQueue.length === 0) {
            this.state.isReviewMode = false;
            this.elements.sidebar.style.display = 'block';
            this.elements.modeIndicator.textContent = '';
            alert('復習が完了しました！');
            this.generateReport();
            return;
        }

        const nextQuestionId = this.state.reviewQueue.shift();
        const nextQuestion = this.data.questions.find(q => q.id === nextQuestionId);
        this.state.currentQuestion = nextQuestion;
        this.displayQuestion();
    },

    // Generate and display the final report
    generateReport() {
        this.elements.reportStudentInfo.innerHTML = `
            <p><strong>出席番号:</strong> ${this.state.studentId}</p>
            <p><strong>名前:</strong> ${this.state.studentName}</p>
        `;
        let totalNotUnderstoodQuestions = 0;
        let tableHTML = `<h2 class="text-2xl font-bold text-gray-700 mb-4">学習成果</h2>` + this.generateReportTable(false);
        this.elements.reportContent.innerHTML = tableHTML;
        const totalReviewAttempts = Object.values(this.state.reportData).reduce((sum, d) => sum + (d.reviewAttempts || 0), 0);
        if (totalReviewAttempts > 0) {
            let reviewTableHTML = `<h2 class="text-2xl font-bold text-gray-700 mt-8 mb-4">復習モードの成果</h2>` + this.generateReportTable(true);
            this.elements.reportReviewContent.innerHTML = reviewTableHTML;
        } else {
            this.elements.reportReviewContent.innerHTML = '';
        }
        
        // NEW: Teacher Mode Info
        const teacherInfoDiv = this.elements.reportTeacherModeInfo;
        if (this.state.teacherModeHistory && this.state.teacherModeHistory.length > 0) {
            let teacherHTML = `<h2 class="text-2xl font-bold text-gray-700 mt-8 mb-4">先生モード利用履歴</h2>`;
            teacherHTML += `<p>利用回数: ${this.state.teacherModeHistory.length}回</p>`;
            teacherHTML += `<ul class="list-disc list-inside">`;
            this.state.teacherModeHistory.forEach(ts => {
                teacherHTML += `<li>${new Date(ts).toLocaleString()}</li>`;
            });
            teacherHTML += `</ul>`;
            teacherInfoDiv.innerHTML = teacherHTML;
        } else {
            teacherInfoDiv.innerHTML = '';
        }

        // NEW: History Timeline
        const historySection = this.elements.reportHistorySection;
        let historyHTML = `<h2 class="text-2xl font-bold text-gray-700 mt-8 mb-4">学習の記録</h2>
                           <div class="border-l-2 border-sky-200 ml-3 pl-8 space-y-8 relative">`;

        if (this.state.startedAt) {
            historyHTML += `
                <div class="relative">
                    <div class="absolute -left-[42px] top-1 bg-sky-500 rounded-full h-5 w-5 border-4 border-white"></div>
                    <h3 class="font-bold text-sky-700">学習開始</h3>
                    <p class="text-gray-600">${new Date(this.state.startedAt).toLocaleString()}</p>
                </div>`;
        }

        if (this.state.resumedHistory && this.state.resumedHistory.length > 0) {
            historyHTML += `
                <div class="relative">
                    <div class="absolute -left-[42px] top-1 bg-yellow-500 rounded-full h-5 w-5 border-4 border-white"></div>
                    <h3 class="font-bold text-yellow-700">再開履歴 (${this.state.resumedHistory.length}回)</h3>
                    <ul class="list-disc list-inside text-gray-600 mt-1">`;
            this.state.resumedHistory.forEach(ts => {
                historyHTML += `<li>${new Date(ts).toLocaleString()}</li>`;
            });
            historyHTML += `</ul></div>`;
        }

        if (this.state.saveHistory && this.state.saveHistory.length > 0) {
             historyHTML += `
                <div class="relative">
                    <div class="absolute -left-[42px] top-1 bg-green-500 rounded-full h-5 w-5 border-4 border-white"></div>
                    <h3 class="font-bold text-green-700">進捗保存履歴 (${this.state.saveHistory.length}回)</h3>
                    <ul class="list-disc list-inside text-gray-600 mt-1">`;
            this.state.saveHistory.forEach(ts => {
                historyHTML += `<li>${new Date(ts).toLocaleString()}</li>`;
            });
            historyHTML += `</ul></div>`;
        }

        historyHTML += `</div>`;
        historySection.innerHTML = historyHTML;

        Object.values(this.state.reportData).forEach(data => {
            if (data.notUnderstoodQuestions) {
                totalNotUnderstoodQuestions += data.notUnderstoodQuestions.length;
            }
        });
        if (totalNotUnderstoodQuestions > 0) {
            this.elements.reviewBtn.classList.remove('hidden');
            this.elements.reviewBtn.textContent = `復習を開始する (${totalNotUnderstoodQuestions}問)`;
        } else {
            this.elements.reviewBtn.classList.add('hidden');
        }
        this.elements.modalOverlay.style.display = 'flex';
        this.elements.startModal.style.display = 'none';
        this.elements.reportModal.classList.remove('hidden', 'scale-95', 'opacity-0');
        this.elements.reportModal.classList.add('scale-100', 'opacity-100');
    },

    generateReportTable(isReview) {
        let totalMistakes = 0, totalCompleted = 0, totalGroups = 0, totalUnderstood = 0, totalNotUnderstood = 0, totalAttempts = 0;
        const prefix = isReview ? 'review' : '';
        const header = isReview ? 
            ['単元名', '挑戦数', '間違い数', '理解度'] : 
            ['単元名', '挑戦数', '間違い数', '達成度', '理解度'];
        let tableHTML = `
            <table class="w-full text-left border-collapse">
                <thead><tr class="bg-gray-100">${header.map(h => `<th class="p-3 border-b-2 border-gray-200 font-bold ${h !== '単元名' ? 'text-center' : ''}">${h}</th>`).join('')}</tr></thead>
                <tbody>`;
        this.data.topics.forEach(topicName => {
            const data = this.state.reportData[topicName];
            const attempts = data[`${prefix}attempts`] || 0; // CORRECTED
            if (isReview && attempts === 0) return;
            const mistakes = data[`${prefix}mistakes`] || 0; // CORRECTED
            const understood = data[`${prefix}understoodCount`] || 0; // CORRECTED
            const notUnderstood = data[`${prefix}notUnderstoodCount`] || 0; // CORRECTED
            const achievement = !isReview && data.totalGroups > 0 ? (data.completedGroups / data.totalGroups) * 100 : 0;
            const understandingTotal = understood + notUnderstood;
            const understandingRate = understandingTotal > 0 ? (understood / understandingTotal) * 100 : 0;
            totalAttempts += attempts;
            totalMistakes += mistakes;
            totalUnderstood += understood;
            totalNotUnderstood += notUnderstood;
            if (!isReview) {
                totalCompleted += data.completedGroups;
                totalGroups += data.totalGroups;
            }
            tableHTML += `
                <tr>
                    <td class="p-3 border-b border-gray-200">${topicName}</td>
                    <td class="p-3 border-b border-gray-200 text-center">${attempts}</td>
                    <td class="p-3 border-b border-gray-200 text-center">${mistakes}</td>
                    ${!isReview ? `<td class="p-3 border-b border-gray-200"><div class="w-full bg-gray-200 rounded-full h-4"><div class="bg-blue-500 h-4 rounded-full text-xs text-white text-center leading-4" style="width: ${achievement.toFixed(0)}%">${achievement.toFixed(0)}%</div></div></td>` : ''}
                    <td class="p-3 border-b border-gray-200"><div class="w-full bg-gray-200 rounded-full h-4"><div class="bg-purple-500 h-4 rounded-full text-xs text-white text-center leading-4" style="width: ${understandingRate.toFixed(0)}%">${understandingRate.toFixed(0)}%</div></div></td>
                </tr>`;
        });
        const overallAchievement = !isReview && totalGroups > 0 ? (totalCompleted / totalGroups) * 100 : 0;
        const overallUnderstandingTotal = totalUnderstood + totalNotUnderstood;
        const overallUnderstandingRate = overallUnderstandingTotal > 0 ? (totalUnderstood / overallUnderstandingTotal) * 100 : 0;
        tableHTML += `
                </tbody>
                <tfoot class="font-bold bg-gray-50">
                    <tr>
                        <td class="p-3 border-t-2 border-gray-300">総合</td>
                        <td class="p-3 border-t-2 border-gray-300 text-center">${totalAttempts}</td>
                        <td class="p-3 border-t-2 border-gray-300 text-center">${totalMistakes}</td>
                        ${!isReview ? `<td class="p-3 border-t-2 border-gray-300"><div class="w-full bg-gray-200 rounded-full h-4"><div class="bg-green-500 h-4 rounded-full text-xs text-white text-center leading-4" style="width: ${overallAchievement.toFixed(0)}%">${overallAchievement.toFixed(0)}%</div></div></td>` : ''}
                        <td class="p-3 border-t-2 border-gray-300"><div class="w-full bg-gray-200 rounded-full h-4"><div class="bg-purple-600 h-4 rounded-full text-xs text-white text-center leading-4" style="width: ${overallUnderstandingRate.toFixed(0)}%">${overallUnderstandingRate.toFixed(0)}%</div></div></td>
                    </tr>
                </tfoot>
            </table>`;
        return tableHTML;
    },

    // Render the Table of Contents
    renderTOC() {
        this.elements.toc.innerHTML = '';
        if (this.state.isTeacherMode) {
            // Teacher Mode: Full, clickable question list
            this.data.topics.forEach((topic, index) => {
                const details = document.createElement('details');
                details.className = 'toc-topic-group';
                // Open the current topic by default
                if (index === this.state.currentTopicIndex) {
                    details.open = true;
                }
                const summary = document.createElement('summary');
                summary.textContent = topic;
                details.appendChild(summary);

                const questionList = document.createElement('ul');
                questionList.className = 'ml-4 mt-1 space-y-1';

                const topicQuestions = this.data.questions.filter(q => q.topicIndex === index);
                topicQuestions.forEach(q => {
                    const li = document.createElement('li');
                    const button = document.createElement('button');
                    button.className = 'toc-question-btn';
                    if (this.state.currentQuestion && q.id === this.state.currentQuestion.id) {
                        button.classList.add('active');
                    }
                    button.textContent = `Q${q.id}: ${q.question.substring(0, 25)}...`;
                    button.title = q.question;
                    button.onclick = () => this.jumpToQuestion(q.id);
                    li.appendChild(button);
                    questionList.appendChild(li);
                });

                details.appendChild(questionList);
                this.elements.toc.appendChild(details);
            });
        } else {
            // Student Mode: Original TOC
            this.data.topics.forEach((topic, index) => {
                const li = document.createElement('li');
                li.textContent = topic;
                li.className = 'toc-item p-3 rounded-md transition-colors';
                if (index < this.state.currentTopicIndex) {
                    li.classList.add('completed');
                } else if (index === this.state.currentTopicIndex) {
                    li.classList.add('active');
                }
                this.elements.toc.appendChild(li);
            });
        }
    },

    // Render math formulas using KaTeX
    renderKaTeX() {
        if (window.renderMathInElement) {
            renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true}
                ]
            });
        }
    },

    // Utility to shuffle an array
    shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    },

    returnToStart() {
        this.elements.modalOverlay.style.display = 'flex';
        this.elements.reportModal.classList.add('hidden', 'scale-95', 'opacity-0');
        this.elements.reportModal.classList.remove('scale-100', 'opacity-100');
        this.elements.startModal.style.display = 'block';
        this.elements.studentIdInput.value = '';
        this.elements.studentNameInput.value = '';
    }
};

// Initialize the application when the DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    app.init();
});
</script>

</body>
</html>


